# 視覺化工具層規範

## 目的
面向用戶的界面層，提供互動式儀表板、圖表、報告和實時監控。從低層消費數據和指標，無需重複業務邏輯。

## 需求

### 需求：統一圖表生成服務
系統應提供集中式服務生成一致、可重用的圖表，無需在儀表板和報告間重複可視化代碼。

#### 場景：創建性能比較圖表
- **當** 用戶想比較兩個策略
- **那麼** 選擇策略、指標（回報率、夏普比、最大回撤）和時間段
- **並且** 調用 ChartService.create_comparison_chart()
- **並且** 系統使用統一格式生成互動式圖表
- **並且** 圖表可嵌入儀表板或導出為 PDF

#### 場景：自定義圖表外觀
- **當** 團隊想在所有報告中保持一致品牌
- **那麼** 一次定義圖表主題（顏色、字體、標籤）
- **並且** 所有圖表自動使用此主題
- **並且** 全局更改主題會更新所有圖表

### 需求：互動式分析儀表板
系統應提供實時儀表板，顯示投資組合性能、交易信號和系統狀態，具有鑽取功能。

#### 場景：交易時段監控投資組合
- **當** 經理打開儀表板
- **那麼** 投資組合概覽顯示總 PnL、配置、風險指標
- **並且** 活躍策略顯示當前狀態和最近信號
- **並且** 通過 WebSocket 實時更新
- **並且** 可以鑽取策略詳情

#### 場景：分析策略性能
- **當** 分析均值回歸策略
- **那麼** 看到隨時間變化的淨值曲線
- **並且** 點擊鑽取特定時期
- **並且** 看到該時期的所有交易並帶有過濾
- **並且** 將交易列表導出為 Excel

### 需求：報告生成框架
系統應提供靈活框架用於以多種格式生成綜合報告，帶有自定義部分和指標。

#### 場景：生成每週性能報告
- **當** 團隊想與利益相關者分享結果
- **那麼** 選擇報告模板（執行摘要、詳細、自定義）
- **並且** 選擇指標和時間段
- **並且** 系統生成專業報告，包含摘要、圖表、策略分解、風險分析
- **並且** 導出為 PDF 並發送給利益相關者

#### 場景：特定利益相關者的自定義報告
- **當** 投資者想要特定分析
- **那麼** 使用其 KPI 創建自定義報告模板
- **並且** 系統每週自動生成
- **並且** 投資者以偏好的格式接收

### 需求：實時性能監控
系統應監控策略執行和系統健康，並針對異常發出警報。

#### 場景：檢測意外的策略行為
- **當** 策略在交易時段表現異常
- **那麼** 實時交易通過 WebSocket 流入
- **並且** 系統檢測異常（異常頻率、規模、回撤）
- **並且** 立即觸發警報
- **並且** 經理可暫停策略並調查

#### 場景：監控系統健康
- **當** 交易時段活躍
- **那麼** 監控 API 響應時間、數據新鮮度、成交率、隊列深度
- **並且** 追蹤錯誤率和系統健康
- **並且** 顯示帶有趨勢線和閾值的指標

### 需求：數據導出和集成
系統應支持輕鬆將結果和指標導出到外部系統。

#### 場景：導出回測結果
- **當** 分析師想在 Excel 中分析結果
- **那麼** 選擇回測和導出格式
- **並且** 系統生成帶有格式化圖表和數據的 Excel
- **並且** 可在 Excel 中應用其他分析

#### 場景：與 BI 儀表板集成
- **當** 組織使用 Tableau 進行報告
- **那麼** 系統將結果導出到數據倉庫
- **並且** Tableau 自動刷新
- **並且** 統一的跨系統報告

### 需求：性能歸因分析
系統應分解性能來源，顯示哪些交易、策略和資產推動回報。

#### 場景：了解回報驅動因素
- **當** 分析季度性能
- **那麼** 顯示歸因分解：
  - 策略 A（均值回歸）：+8%
  - 策略 B（動量）：+5%
  - 策略 C（ML 模型）：-1%
- **並且** 按資產進一步分解

#### 場景：風險歸因
- **當** 分析所承擔的風險
- **那麼** 顯示波動率來源和分散效應
- **並且** 了解風險集中位置

### 需求：重構儀表板 API 路由
所有儀表板 API 路由應消費效能計算層 API 而非自己進行計算。

#### 場景：更新路由調用計算 API
- **當** 儀表板路由需要性能指標
- **那麼** 調用計算層 API 而非直接計算
- **並且** 路由處理器專注於格式化和錯誤處理
- **並且** 改進可維護性和一致性

### 需求：合併圖表生成代碼
所有重複的圖表生成代碼應合併到統一的 ChartService 中。

#### 場景：合併多個圖表實現
- **當** 從儀表板和報告合併圖表代碼
- **那麼** 合併到 ChartService 方法
- **並且** 移除重複實現
- **並且** 確保向後兼容性

## 依賴關係
- **數據管理層**：查詢原始和處理數據
- **效能計算層**：消費指標和結果
- **代理系統**：儀表板的系統狀態
- **數據庫**：用於趨勢分析和檔案的歷史數據

## 交叉參考
- 相關文檔：數據管理層規範
- 相關文檔：效能計算層規範
