# 效能計算層規範

## 目的
核心處理引擎，實現交易邏輯、變數管理、參數優化、異常檢測、結果標準化和聚合，消除跨代理和回測模塊的重複計算。

## 需求

### 需求：變數管理系統
系統應提供對策略變數（市場數據、指標、衍生值）的集中管理，自動依賴追蹤、延遲評估和結果快取。

#### 場景：管理動態指標計算
- **當** 動量策略需要多個技術指標（SMA、EMA、RSI、MACD）
- **那麼** 變數管理器追蹤指標之間的依賴關係
- **並且** 按正確順序計算指標
- **並且** 快取結果以避免重複計算
- **並且** 新數據到達時增量更新

#### 場景：參數敏感性分析
- **當** 優化策略參數（回看期=[10,20,30]，閾值=[0.5,0.6,0.7]）
- **那麼** 變數管理器為每個組合創建快照
- **並且** 每個快照在整個回測期間有一致的值
- **並且** 便於比較參數組合的性能差異

### 需求：參數管理系統
系統應提供靈活的策略參數定義、存儲和檢索系統，具有優化歷史、最佳參數集和版本追蹤。

#### 場景：存儲優化結果
- **當** 均值回歸策略的網格搜索完成
- **那麼** 所有 1000 個參數組合連同性能指標被存儲
- **並且** 前 10 個組合按夏普比率排名
- **並且** 每個集合標記有日期、資產、期間和指標

#### 場景：加載和部署參數
- **當** 將策略部署到實時交易
- **那麼** 從優化歷史加載最佳參數集
- **並且** 驗證參數在可接受範圍內
- **並且** 應用信心指標

### 需求：異常檢測和處理
系統應檢測統計異常，包括交易錯誤、數據問題和非預期市場波動，並帶有信心評分。

#### 場景：檢測策略執行異常
- **當** 策略在回測期間生成異常交易頻率
- **那麼** 異常檢測器識別異常情況
- **並且** 標記供調查
- **並且** 回測繼續但報告中帶有警告

#### 場景：檢測市場數據異常
- **當** 計算日回報時出現 10% 的價格跳躍
- **那麼** 系統將其檢測為異常
- **並且** 將其與其他股票相關聯（市場範圍或股票特定）
- **並且** 以信心水平標記

### 需求：結果標準化
系統應標準化不同策略、資產和時間段的性能指標以實現有意義的比較。

#### 場景：比較兩個不同特徵的策略
- **當** 比較均值回歸（15% 回報率、10% 波動率）vs 市場中立（20% 回報率、25% 波動率）
- **那麼** 將指標標準化到 0-1 範圍
- **並且** 在雷達圖上可視化相對優勢
- **並且** 實現公平比較

#### 場景：時間段標準化
- **當** 比較策略在 2022 年（熊市）和 2023 年（牛市）的性能
- **那麼** 使用市場背景進行標準化
- **並且** 計算相對基準的 alpha
- **並且** 實現公平的跨期比較

### 需求：結果聚合
系統應將多個策略、資產和期間的性能指標聚合成綜合摘要。

#### 場景：投資組合級別聚合
- **當** 分析 5 個策略的投資組合
- **那麼** 將指標組合成投資組合指標
- **並且** 按配置權重
- **並且** 報告個別和投資組合性能

#### 場景：跨資產分析
- **當** 分析多隻股票的性能
- **那麼** 使用簡單、市值或自定義加權聚合
- **並且** 確定哪些行業/股票驅動性能

### 需求：核心回測引擎
系統應提供使用變數管理和參數系統的重構回測引擎，用於高效的策略驗證。

#### 場景：運行高效回測
- **當** 在 10 隻股票上回測 5 年策略
- **那麼** 從數據管理層加載數據
- **並且** 初始化具有指標的變數管理器
- **並且** 遍歷每一天，更新變數和生成信號
- **並且** 執行交易並追蹤頭寸
- **並且** 計算綜合性能指標

#### 場景：並行回測
- **當** 網格搜索 100 個參數組合
- **那麼** 啟動並行回測進程
- **並且** 每個進程運行不同組合
- **並且** 聚合結果識別最佳參數

### 需求：交易邏輯框架
系統應提供用於實現交易策略的標準化接口，具有一致的信號生成和執行。

#### 場景：實現新策略
- **當** 創建自定義動量策略
- **那麼** 實現 IStrategy 接口
- **並且** 覆蓋 generate_signals() 方法
- **並且** 通過變數管理器訪問變數
- **並且** 返回 BUY/SELL/HOLD 信號
- **並且** 框架處理執行和報告

#### 場景：條件訂單執行
- **當** 策略具有複雜的執行邏輯
- **那麼** 生成信號但執行引擎檢查約束
- **並且** 驗證頭寸限制和滑點預期
- **並且** 決定全額成交、部分成交或跳過
- **並且** 記錄每個執行決定的理由

### 需求：重構現有策略
所有現有策略應更新以使用新的變數管理和參數系統。

#### 場景：遷移技術策略
- **當** 更新技術分析策略
- **那麼** 遷移到新框架
- **並且** 確保向後兼容性
- **並且** 驗證結果與舊版本相符

### 需求：合併效能計算邏輯
跨代理和回測模塊的所有重複計算應合併在此層中。

#### 場景：集中化指標計算
- **當** 從代理合併性能指標
- **那麼** 移動到性能計算器
- **並且** 代理調用計算 API
- **並且** 消除重複

## 依賴關係
- **數據管理層**：消費標準化數據
- **視覺化工具層**：提供聚合指標和結果
- **代理系統**：代理使用的性能計算 API

## 交叉參考
- 相關文檔：數據管理層規範
- 相關文檔：視覺化工具層規範
