# 數據管理層規範

## 目的
提供統一、標準化的多源財務市場數據訪問。數據管理層處理數據獲取、驗證、清理、時間對齐和數據庫持久化，消除系統中的重複功能。

## 需求

### 需求：統一數據源接口
系統應提供所有數據源必須實現的標準化接口，消除基於數據源類型的不同代碼路徑需求。

#### 場景：添加新的數據源（如 Bloomberg API）
- **當** 開發者需要將 Bloomberg 數據集成到系統
- **那麼** 他們創建實現 `IDataSource` 接口的新類
- **並且** 實現三個必需方法：`fetch_raw()`, `validate()`, `get_metadata()`
- **並且** 在數據源工廠中註冊源
- **並且** 整個系統現在可以使用 Bloomberg 數據，無需修改現有代碼

#### 場景：同時從多個源獲取數據
- **當** 策略需要來自 HTTP API 和 Yahoo Finance 的數據進行比較
- **那麼** 系統創建兩個指向不同源的 `DataSourceAdapter` 實例
- **並且** 在每個實例上調用 `fetch_historical()`，接收標準化的 `MarketDataFrame`
- **並且** 可以使用統一格式合併數據，無需源特定的解析邏輯

#### 場景：透明切換數據源
- **當** 數據源 API 變得不可靠或停止服務
- **那麼** 開發者可以通過改變配置切換到替代源
- **並且** 無需進行代碼更改
- **並且** 系統自動使用新源進行後續數據獲取

### 需求：標準化數據驗證管道
系統應驗證所有傳入數據以確保在用於計算前滿足質量標準，並為每個數據集附加質量評分。

#### 場景：檢測缺失的 OHLCV 數據
- **當** 獲取股票 5 年的歷史數據
- **那麼** 驗證器檢測到某些日期的缺失收盤價
- **並且** 記錄間隙並決定是否填充、插值或排除
- **並且** 為數據集附加質量評分（0-100），指示數據完整性

#### 場景：檢測異常價格波動（股票拆分、錯誤）
- **當** 獲取顯示單日 50% 價格跳躍的實時數據
- **那麼** 異常檢測器將其識別為潛在數據錯誤或股票拆分
- **並且** 以信心水平（高/中/低）標記數據點
- **並且** 提供處理建議（手動審查、使用穩健方法）

#### 場景：跨多個源的數據質量評分
- **當** 從多個源獲取相同股票的數據
- **那麼** 每個源獲得獨立質量評分
- **並且** 評分基於完整性、準確性、新鮮度和一致性指標
- **並且** 系統可以根據質量評分選擇或加權源

### 需求：時間對齐和標準化
系統應確保來自不同源的數據時間對齐一致，正確處理市場時段、假日和時區差異。

#### 場景：合併日內數據與每日宏觀指標
- **當** 合併小時股票價格數據（9:30 AM - 4:00 PM）與每日經濟指標
- **那麼** 時間對齐器將每個小時映射到正確的交易日
- **並且** 經濟指標正確關聯到市場交易時段
- **並且** 無數據洩露（未來數據不會在可用前出現）

#### 場景：處理市場假日
- **當** 跨越 HKEX 關閉的農曆新年進行回測
- **那麼** 系統識別 HKEX 交易日曆並標記休市日期
- **並且** 將前一收盤價結轉以避免數據間隙
- **並且** 成交量標記為零
- **並且** 計算考慮交易期間的時間間隙

#### 場景：全球數據的時區轉換
- **當** 合併香港股票數據與美國市場數據
- **那麼** 所有時間戳轉換為一致的參考時區
- **並且** 日內數據在時區邊界上正確對齐
- **並且** 指標計算尊重原始本地時間

### 需求：資產檔案管理
系統應維護每項資產（股票）的綜合元數據，包括行業、產業、上市日期、交易時段和特殊特徵。

#### 場景：理解股票特定特徵
- **當** 分析騰訊（0700.HK）
- **那麼** 系統檢索包含以下內容的資產檔案：
  - 上市日期：2017 年 10 月 16 日
  - 行業：科技，子行業：互聯網
  - 交易時段：9:30-12:00, 13:00-16:00 HK 時間
  - 貨幣：HKD
  - 特殊標誌：符合南向通資格
- **並且** 此信息影響數據需求和分析參數

#### 場景：基於標準過濾資產
- **當** 為動量策略選擇股票
- **那麼** 用戶查詢所有行業 = "金融" 且成交量 > 1000 萬的資產
- **並且** 排除上市日期 < 2 年的股票
- **並且** 僅包括符合南向通資格的股票
- **並且** 系統返回可供分析的預過濾列表

#### 場景：投資組合成分驗證
- **當** 使用多隻股票創建投資組合
- **那麼** 系統驗證股票具有兼容的交易日曆
- **並且** 驗證投資組合未在單一行業過度集中
- **並且** 提醒即將進行的公司行動（拆分、分紅）

### 需求：數據庫持久化 (ORM)
系統應提供統一的數據庫接口用於存儲和檢索市場數據和衍生數據集，通過快取避免重複 API 調用。

#### 場景：快取市場數據以避免重複 API 調用
- **當** 在相同歷史期間（2020-2025）對多個策略進行回測，針對股票 0700.HK
- **那麼** 首次獲取調用 HTTP API 並返回 5 年 OHLCV 數據
- **並且** 數據自動持久化到數據庫
- **並且** 後續相同數據的獲取從數據庫檢索（瞬時響應）
- **並且** 定期刷新（每小時/每天）從 API 更新數據

#### 場景：查詢衍生數據集
- **當** 為機器學習模型訓練準備數據
- **那麼** 查詢 2024 年 Q3 的 0700.HK 所有標準化價格回報
- **並且** 獲取預計算的特徵工程結果
- **並且** 將這些添加到訓練數據集而無需重新計算

#### 場景：高效的歷史數據導出
- **當** 分析師需要 10 年的市場數據用於研究
- **那麼** 系統執行單個高效的數據庫查詢
- **並且** 為大數據集返回分頁結果
- **並且** 支持數據庫中的過濾、排序和聚合

### 需求：遺留適配器遷移
所有現有數據適配器實現應重構以使用新的 `IDataSource` 接口，同時保持向後兼容性。

#### 場景：將 HTTP API 適配器遷移到新接口
- **當** 遺留 HTTP 適配器需要更新
- **那麼** 舊代碼重構以繼承 `IDataSource`
- **並且** 實現 `fetch_raw()`, `validate()`, `get_metadata()` 方法
- **並且** 所有現有調用代碼無需更改即可繼續工作
- **並且** 驗證後刪除舊適配器實現

#### 場景：合併重複的適配器
- **當** 原始數據適配器和文件源需要相同功能
- **那麼** 它們合併為單個 `FileDataSource` 實現
- **並且** 在過渡期間兩個舊名稱別名到新實現
- **並且** 所有測試通過後刪除舊文件

### 需求：移除重複的數據適配器
系統應消除提供重疊功能的冗餘數據適配器實現。

#### 場景：合併原始數據和文件源適配器
- **當** 審查現有適配器
- **那麼** `src/data_adapters/raw_data_adapter.py` 合併到文件源
- **並且** `src/data_adapters/hkex_adapter.py` 中的重複清理邏輯移動到清理層
- **並且** 遺留 HTTP 適配器替換為統一實現
- **並且** 所有測試通過後安全移除舊文件

## 依賴關係
- **效能計算層**：通過 IDataSource 接口依賴此層的數據
- **視覺化工具層**：查詢數據管理 API 用於圖表生成
- **代理系統**：數據科學家和量化分析師代理消費標準化數據

## 交叉參考
- 相關文檔：效能計算層規範
- 相關文檔：視覺化工具層規範
- 依賴於：CLAUDE.md 中的項目約定和編碼標準
