# Telegram Bot å„ªåŒ–è¨­è¨ˆæ–¹æ¡ˆ

**è®Šæ›´ID**: telegram-bot-optimization-v1
**è¨­è¨ˆç‰ˆæœ¬**: v1.0

## ğŸ—ï¸ æ•´é«”æ¶æ§‹è¨­è¨ˆ

### è¨­è¨ˆåŸå‰‡
1. **ç°¡åŒ–å„ªå…ˆ**: ç§»é™¤ä¸å¿…è¦çš„åŠŸèƒ½ï¼Œå°ˆæ³¨æ ¸å¿ƒåƒ¹å€¼
2. **æ€§èƒ½å°å‘**: å„ªåŒ–å›æ‡‰æ™‚é–“å’Œè³‡æºä½¿ç”¨
3. **æ•¸æ“šæº–ç¢º**: ä½¿ç”¨å®˜æ–¹/æ¬Šå¨æ•¸æ“šæº
4. **å‘ä¸‹å…¼å®¹**: ä¿ç•™ç¾æœ‰æ ¸å¿ƒåŠŸèƒ½

### æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Telegram Bot                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Command Handlers (18 commands)            â”‚
â”‚  â”œâ”€â”€ åŸºç¤ç³»çµ± (5)                           â”‚
â”‚  â”œâ”€â”€ é‡åŒ–äº¤æ˜“ (4)                           â”‚
â”‚  â”œâ”€â”€ æŠ•è³‡çµ„åˆ (1)                           â”‚
â”‚  â”œâ”€â”€ åƒ¹æ ¼è­¦å ± (1)                           â”‚
â”‚  â”œâ”€â”€ ç†±åŠ›åœ– (1)                             â”‚
â”‚  â”œâ”€â”€ é«”è‚²æ¯”åˆ† (4)                           â”‚
â”‚  â”œâ”€â”€ AIåŠ©æ‰‹ (1)                             â”‚
â”‚  â”œâ”€â”€ ç”Ÿæ´»æœå‹™ (1) [Weather + Mark6]        â”‚
â”‚  â””â”€â”€ æ¶ˆæ¯æ­·å² (0) [å·²ç§»é™¤]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service Layer                              â”‚
â”‚  â”œâ”€â”€ mark6_service.py        [NEW]         â”‚
â”‚  â”œâ”€â”€ weather_service.py      [UPGRADED]    â”‚
â”‚  â”œâ”€â”€ sports_scoring/         [UPGRADED]    â”‚
â”‚  â”œâ”€â”€ portfolio_manager.py    [UNCHANGED]   â”‚
â”‚  â”œâ”€â”€ alert_manager.py        [UNCHANGED]   â”‚
â”‚  â””â”€â”€ heatmap_service.py      [UNCHANGED]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Layer                                 â”‚
â”‚  â”œâ”€â”€ é¦™æ¸¯å¤©æ–‡å° API    [NEW]               â”‚
â”‚  â”œâ”€â”€ è¶³æ™ºå½©æ•¸æ“šæº       [NEW]              â”‚
â”‚  â”œâ”€â”€ HKJC å…­åˆå½©æ•¸æ“š   [NEW]               â”‚
â”‚  â””â”€â”€ çµ±ä¸€æ•¸æ“šAPI        [EXISTING]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Caching Layer                              â”‚
â”‚  â”œâ”€â”€ Memory Cache (LRU)                    â”‚
â”‚  â””â”€â”€ Redis Cache (Optional)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ è©³ç´°è¨­è¨ˆæ–¹æ¡ˆ

### 1. å‘½ä»¤ç°¡åŒ–è¨­è¨ˆ

#### ç§»é™¤çš„å‘½ä»¤
- `/id`: ç”¨æˆ¶åé¥‹ç„¡å¯¦éš›åƒ¹å€¼
- `/echo`: åƒ…å›è²åŠŸèƒ½ï¼Œå¯ç”¨å…¶ä»–å‘½ä»¤æ›¿ä»£
- `/history`: å ç”¨ç³»çµ±è³‡æºï¼Œä½¿ç”¨ç‡ä½

#### ç°¡åŒ–ç­–ç•¥
- **åˆ†é¡é‡çµ„**: æŒ‰åŠŸèƒ½å°‡18å€‹å‘½ä»¤åˆ†æˆ8é¡
- **æè¿°ç²¾ç°¡**: æ¯å€‹å‘½ä»¤æè¿° < 20å­—
- **ç¤ºä¾‹ç²¾ç°¡**: æ¯é¡å‘½ä»¤æä¾›1-2å€‹ç¤ºä¾‹

#### å¹«åŠ©æ–‡æª”é‡æ§‹
```python
# èˆŠç‰ˆ: 410 è¡Œ
# æ–°ç‰ˆ: ç›®æ¨™ < 250 è¡Œ

åˆ†é¡é¡¯ç¤º:
â”œâ”€â”€ é‡åŒ–äº¤æ˜“: /analyze, /optimize, /risk, /sentiment
â”œâ”€â”€ æŠ•è³‡ç®¡ç†: /portfolio, /alert, /heatmap
â”œâ”€â”€ é«”è‚²æ¯”åˆ†: /score, /schedule, /favorite
â”œâ”€â”€ ç”Ÿæ´»æœå‹™: /weather, /mark6  [æ–°å¢]
â””â”€â”€ ç³»çµ±åŠŸèƒ½: /start, /help, /status
```

### 2. Mark6 æœå‹™è¨­è¨ˆ

#### æ•¸æ“šæº
- **ä¸»è¦æº**: https://bet.hkjc.com/ch/marksix
- **å‚™ç”¨æº**: https://bet.hkjc.com/marksix (è‹±æ–‡ç‰ˆ)
- **æ•¸æ“šæ›´æ–°**: æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡

#### æ•¸æ“šçµæ§‹
```json
{
  "next_draw": {
    "draw_no": "2024125",
    "date": "2025-10-30",
    "time": "21:30",
    "estimated_prize": "28,000,000",
    "currency": "HKD"
  },
  "last_draw": {
    "draw_no": "2024124",
    "date": "2025-10-28",
    "result": ["03", "15", "22", "31", "44", "49"],
    "special": "08"
  }
}
```

#### éŸ¿æ‡‰æ ¼å¼ (ç°¡åŒ–ç‰ˆ)
```
ğŸ° å…­åˆå½©ä¸‹æœŸæ”ªç 

æœŸæ•¸: 2024125
æ—¥æœŸ: 10æœˆ30æ—¥ (ä¸‰)
æ™‚é–“: 21:30
ä¼°è¨ˆé ­çåŸºé‡‘: $2,800è¬

ğŸ’¡ é–‹çæ™‚é–“: é€¢é€±äºŒã€å››ã€å…­ 21:15
```

### 3. é«”è‚²æ¯”åˆ†ç³»çµ±å‡ç´šè¨­è¨ˆ

#### æ•¸æ“šæºå‡ç´š
- **èˆŠç³»çµ±**: ç¬¬ä¸‰æ–¹é«”è‚²ç¶²ç«™èšåˆ
- **æ–°ç³»çµ±**: è¶³æ™ºå½©å®˜æ–¹æ•¸æ“š
- **å„ªå‹¢**: å®˜æ–¹æº–ç¢ºæ€§æ›´é«˜ã€æ›´æ–°æ›´å¿«

#### æ¶æ§‹æ”¹é€²
```python
class JokerSportsAdapter(BaseAdapter):
    """è¶³æ™ºå½©æ•¸æ“šé©é…å™¨"""

    async def fetch_joker_data(self, sport_type: str):
        # æŠ“å– https://bet.hkjc.com/ch/football/home
        # è§£ææ•¸æ“š
        # è¿”å›æ¨™æº–åŒ–æ ¼å¼

class ImprovedScoreProcessor:
    """æ”¹é€²çš„æ¯”åˆ†è™•ç†å™¨"""

    def format_score(self, games):
        # å„ªå…ˆé¡¯ç¤ºè¶³æ™ºå½©æ•¸æ“š
        # æ¨™è¨˜æ•¸æ“šä¾†æº
        # æ·»åŠ æº–ç¢ºæ€§æŒ‡ç¤º
```

#### æ•¸æ“šèåˆç­–ç•¥
1. **å„ªå…ˆç´š**: è¶³æ™ºå½© > èˆŠæ•¸æ“šæº
2. **å¿«å–**: 120ç§’TTL
3. **å®¹éŒ¯**: è¶³æ™ºå½©å¤±æ•ˆæ™‚è‡ªå‹•å›é€€åˆ°èˆŠç³»çµ±
4. **æ¨™è­˜**: åœ¨å›æ‡‰ä¸­æ¨™è¨˜æ•¸æ“šä¾†æº

### 4. å¤©æ°£æœå‹™æ”¹é€²è¨­è¨ˆ

#### æ•¸æ“šæºå‡ç´š
- **èˆŠç³»çµ±**: ç¬¬ä¸‰æ–¹å¤©æ°£API
- **æ–°ç³»çµ±**: é¦™æ¸¯å¤©æ–‡å° API
- **URL**: http://weather.gov.hk/
- **æ•¸æ“šé¡å‹**: ä¹å¤©å¤©æ°£é å ±ã€è­¦å‘Šä¿¡è™Ÿã€å³æ™‚å¤©æ°£

#### æœå‹™æ”¹é€²
```python
class HKOWeatherService:
    """é¦™æ¸¯å¤©æ–‡å°å¤©æ°£æœå‹™"""

    async def get_current_weather(self):
        # å¾å¤©æ–‡å°APIç²å–å¯¦æ™‚æ•¸æ“š
        # è¿”å›çµæ§‹åŒ–æ•¸æ“š

    async def get_weather_warning(self):
        # ç²å–ç•¶å‰è­¦å‘Šä¿¡è™Ÿ
        # é¡å‹: é…·ç†±/é›·æš´/é¢±é¢¨ç­‰

    def format_weather_message(self, data):
        # ç°¡åŒ–æ ¼å¼
        # ä¿ç•™æ ¸å¿ƒä¿¡æ¯
```

#### éŸ¿æ‡‰æ ¼å¼æ”¹é€²
```
ğŸŒ¤ï¸ é¦™æ¸¯å¤©æ°£ (2025-10-28 14:00)

ğŸŒ¡ï¸ æº«åº¦: 26Â°C (æ¿•åº¦ 65%)
ğŸŒ¬ï¸ é¢¨å‘: æ±é¢¨ 15 km/h
â˜ï¸ å¤©æ°£: éƒ¨åˆ†å¤šé›²

âš ï¸ è­¦å‘Š: ç„¡

æ•¸æ“šæº: é¦™æ¸¯å¤©æ–‡å°
```

### 5. æ€§èƒ½å„ªåŒ–è¨­è¨ˆ

#### å›æ‡‰æ™‚é–“å„ªåŒ–
1. **æ¶ˆæ¯å£“ç¸®**
   - ç§»é™¤å¤šé¤˜è¡¨æƒ…ç¬¦è™Ÿ
   - ç²¾ç°¡æè¿°æ–‡å­—
   - ä¿ç•™é—œéµæ•¸æ“š

2. **ç•°æ­¥è™•ç†**
   - ä½¿ç”¨ asyncio ä½µç™¼è™•ç†
   - éé˜»å¡APIèª¿ç”¨
   - é€£æ¥æ± å„ªåŒ–

3. **ç·©å­˜ç­–ç•¥**
   - å…§å­˜LRUç·©å­˜: çŸ­æœŸæ•¸æ“š
   - Redisç·©å­˜ (å¯é¸): é•·æœŸæ•¸æ“š
   - æ™ºèƒ½å¤±æ•ˆ: æ ¹æ“šæ•¸æ“šé¡å‹è¨­ç½®TTL

#### ç·©å­˜è¨­è¨ˆ
```python
CACHE_CONFIG = {
    "stock_data": 300,      # 5åˆ†é˜
    "weather_data": 3600,   # 1å°æ™‚
    "sports_data": 120,     # 2åˆ†é˜
    "mark6_data": 3600,     # 1å°æ™‚
}
```

#### ç›£æ§æŒ‡æ¨™
```python
PERFORMANCE_METRICS = {
    "response_time": "å¹³å‡éŸ¿æ‡‰æ™‚é–“",
    "cache_hit_rate": "ç·©å­˜å‘½ä¸­ç‡",
    "api_call_count": "APIèª¿ç”¨æ¬¡æ•¸",
    "error_rate": "éŒ¯èª¤ç‡",
}
```

## ğŸ”„ éŒ¯èª¤è™•ç†è¨­è¨ˆ

### å®¹éŒ¯æ©Ÿåˆ¶
1. **æ•¸æ“šæºå¤±æ•ˆ**: è‡ªå‹•åˆ‡æ›åˆ°å‚™ç”¨æº
2. **APIè¶…æ™‚**: é‡è©¦3æ¬¡å¾Œè¿”å›ç·©å­˜æ•¸æ“š
3. **ç¶²çµ¡éŒ¯èª¤**: è¿”å›å‹å¥½éŒ¯èª¤æ¶ˆæ¯
4. **æ•¸æ“šè§£æéŒ¯èª¤**: è¨˜éŒ„æ—¥èªŒï¼Œè¿”å›éŒ¯èª¤æç¤º

### éŒ¯èª¤æ¶ˆæ¯æ ¼å¼
```
âŒ æœå‹™æš«æ™‚ä¸å¯ç”¨

åŸå› : [å…·é«”éŒ¯èª¤]
å»ºè­°: è«‹ç¨å¾Œé‡è©¦
```

## ğŸ§ª æ¸¬è©¦è¨­è¨ˆ

### æ¸¬è©¦ç­–ç•¥
1. **å–®å…ƒæ¸¬è©¦**: è¦†è“‹ç‡ > 80%
2. **é›†æˆæ¸¬è©¦**: ç«¯åˆ°ç«¯æ¸¬è©¦æ‰€æœ‰å‘½ä»¤
3. **æ€§èƒ½æ¸¬è©¦**: 100ä¸¦ç™¼ç”¨æˆ¶å£“åŠ›æ¸¬è©¦
4. **ç”¨æˆ¶é©—æ”¶**: 5åçœŸå¯¦ç”¨æˆ¶æ¸¬è©¦

### æ¸¬è©¦ç”¨ä¾‹ç¤ºä¾‹
```python
# Mark6 æ¸¬è©¦
def test_mark6_next_draw():
    data = await get_next_draw_info()
    assert "draw_no" in data
    assert "date" in data
    assert "estimated_prize" in data

# å¤©æ°£æœå‹™æ¸¬è©¦
def test_hko_weather_accuracy():
    hko_data = await get_real_time_weather()
    # å°æ¯”å®˜æ–¹ç¶²ç«™æ•¸æ“š
    assert abs(hko_data.temperature - official_data.temperature) < 1
```

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬é‡æ–¹æ³• |
|------|--------|----------|
| å¹³å‡éŸ¿æ‡‰æ™‚é–“ | < 1.5ç§’ | ç«¯åˆ°ç«¯æ¸¬è©¦ |
| 95åˆ†ä½éŸ¿æ‡‰æ™‚é–“ | < 3ç§’ | å£“åŠ›æ¸¬è©¦ |
| ç·©å­˜å‘½ä¸­ç‡ | > 70% | ç›£æ§æ—¥èªŒ |
| éŒ¯èª¤ç‡ | < 1% | ç”Ÿç”¢ç’°å¢ƒç›£æ§ |
| CPUä½¿ç”¨ç‡ | < 50% | ç³»çµ±ç›£æ§ |
| å…§å­˜ä½¿ç”¨ç‡ | < 70% | ç³»çµ±ç›£æ§ |

## ğŸš€ éƒ¨ç½²è¨­è¨ˆ

### éƒ¨ç½²ç­–ç•¥
1. **æ¼¸é€²å¼éƒ¨ç½²**: å…ˆéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
2. **ç°åº¦ç™¼å¸ƒ**: é€æ­¥é–‹æ”¾æ–°åŠŸèƒ½
3. **å¿«é€Ÿå›æ»¾**: ä¿ç•™ä¸Šå€‹ç‰ˆæœ¬ä»¥å‚™å›æ»¾

### ç’°å¢ƒé…ç½®
```yaml
# ç”Ÿç”¢ç’°å¢ƒ
ENVIRONMENT: production
CACHE_ENABLED: true
CACHE_TTL: 300
PERFORMANCE_MONITORING: true

# æ¸¬è©¦ç’°å¢ƒ
ENVIRONMENT: testing
CACHE_ENABLED: false
PERFORMANCE_MONITORING: true
```

---

**è¨­è¨ˆå¸«**: Claude Code
**å¯©æ ¸**: å¾…å¯©æ ¸
**ç‰ˆæœ¬**: v1.0
**æœ€å¾Œæ›´æ–°**: 2025-10-28
