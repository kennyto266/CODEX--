# OpenSpec 提案：Telegram Bot 真實數據源整合與功能修復

## 提案概述

全面整合真實數據源到 Telegram Bot，包括 ESPN NBA/足球數據和 HKJC 彩票數據，同時修復 Bot 穩定性和用戶體驗問題，實現完整的真實數據驅動功能。

## 實際完成的工作 (2025-11-01)

### ✅ 核心數據源整合

1. **ESPN NBA API** - 實時 NBA 比分數據
2. **ESPN 足球 API + 英超官網** - 足球比分數據
3. **HKJC 官網** - 真實彩票數據 (使用 Chrome MCP 爬取)

### ✅ Bot 功能修復

1. **Mark6 數據顯示修復** - 從 N/A 改為真實數據
2. **/start 命令優化** - 添加版本信息 (Telegram v1.2.0)
3. **409 衝突解決** - 實施進程管理和單實例運行

## 變更原因

**原有問題**:
- Mark6 數據顯示 N/A 和 0
- Bot 409 衝突導致無響應
- 缺乏版本信息和專業自我介紹
- 數據源不夠準確

**解決方案**:
1. **真實數據源**: ESPN + HKJC 官方數據
2. **穩定運行**: 解決 409 衝突問題
3. **專業體驗**: 添加版本信息和功能說明
4. **數據準確**: 所有信息來自官方來源

## 目標

### 主要目標

1. **集成英超官網數據源**
   - 支持從 `https://www.premierleague.com/en/matches?competition=8&season=2025&matchweek=X&month=Y` 獲取數據
   - 自動檢測賽季、週數和月份
   - 解析 JSON 或 HTML 結構

2. **增強足球功能**
   - 實時英超比分查詢
   - 未來賽程顯示
   - 比賽狀態追蹤（進行中、半場、已結束）

3. **改進數據處理**
   - 解析比賽詳細信息
   - 處理時區轉換（GMT → HKT）
   - 格式化中文球隊名稱

## 影響範圍

### 直接影響的文件

1. **修改文件**:
   - `src/telegram_bot/sports_scoring/football_scraper.py` - 添加英超官網爬蟲
   - `src/telegram_bot/sports_scoring/real_data_fetcher.py` - 整合新的數據源

2. **測試文件**:
   - `test_sports_scoring.py` - 更新測試用例
   - 添加英超官網專用測試

3. **配置/文檔**:
   - 更新 API 文檔
   - 用戶使用說明

### 影響的功能

- `/score soccer` 命令 - 將包含英超官網數據
- `/schedule soccer` 命令 - 支持英超賽程查詢
- 實時比分更新功能
- 比賽狀態監控

## 技術方案

### 數據獲取策略

1. **優先級順序**:
   - 英超官網 (premierleague.com) - 優先級最高
   - ESPN API - 作為備用
   - 模擬數據 - 最後回退

2. **請求方法**:
   - 使用 Chrome MCP 進行動態內容爬取
   - 支持參數化查詢（賽季、週數、月份）
   - 實現請求限流（每分鐘最多 20 次）

3. **數據解析**:
   - 提取比賽基本信息（主隊、客隊、比分）
   - 獲取比賽狀態（時間、補時）
   - 解析聯賽信息

### 錯誤處理

- 網站維護 → 自動切換到備用數據源
- 數據延遲 → 標記延遲狀態
- 網絡錯誤 → 重試機制
- 解析錯誤 → 記錄日誌並使用備用源

## 驗收標準

1. **功能測試**:
   - 能成功獲取英超比分
   - 能顯示未來 7 天賽程
   - 能正確解析比賽狀態

2. **性能要求**:
   - 響應時間 < 3 秒
   - 成功率 > 95%
   - 緩存命中率 > 70%

3. **兼容性**:
   - 保持現有功能不受影響
   - 支援多個並發請求
   - 正確處理邊緣情況

## 風險評估

### 風險

1. **網站結構變更** - 英超官網可能改版
   - 緩解: 實現健壯的解析器
   - 監控: 定期檢查解析是否正常

2. **訪問限制** - 網站可能封鎖爬蟲
   - 緩解: 使用 Chrome MCP 和合理的請求間隔
   - 監控: 監控 HTTP 狀態碼

3. **數據不完整** - 部分比賽可能缺失
   - 緩解: 使用多個數據源
   - 監控: 檢查數據完整性

### 緩解措施

- 實施健壯的錯誤處理
- 使用多層數據源備份
- 實現詳細日誌記錄
- 定期監控數據質量

## 實施計劃

### 階段 1: 基礎架構 (1-2 天)
- 創建英超官網爬蟲類
- 實現基本數據解析
- 添加錯誤處理機制

### 階段 2: 整合測試 (1 天)
- 整合到現有系統
- 測試多數據源切換
- 驗證性能指標

### 階段 3: 優化部署 (1 天)
- 優化請求速度
- 完善日誌和監控
- 撰寫文檔

## 成功指標

1. **技術指標**:
   - 成功獲取英超比分 > 95%
   - 平均響應時間 < 3 秒
   - 零崩潰率

2. **功能指標**:
   - 實時比分更新延遲 < 30 秒
   - 賽程查詢覆蓋率 100%
   - 錯誤恢復時間 < 10 秒

3. **用戶體驗**:
   - 消息格式清晰易讀
   - 支持中文球隊名稱
   - 提供有用的比賽詳情

## 依賴關係

- 依賴 `chrome-devtools-mcp` 進行網頁爬取
- 依賴現有的 Telegram bot 框架
- 依賴現有的足球數據處理邏輯

## 驗證步驟

1. 單元測試英超爬蟲功能
2. 集成測試多數據源場景
3. 負載測試並發查詢
4. 用戶驗收測試

## 總結

本提案旨在通過整合英超聯賽官網數據源，提升 Telegram bot 足球功能的準確性和用戶體驗。通過實施多數據源策略和健壯的錯誤處理，確保系統的可靠性和穩定性。

---

**提案人**: Claude Code
**創建時間**: 2025-10-31
**狀態**: 待審核
