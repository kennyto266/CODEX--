name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # 代码质量检查
  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: 代码格式检查 (Black)
        run: |
          black --check --diff src/

      - name: 导入排序检查 (isort)
        run: |
          isort --check-only --diff src/

  # 后端测试
  backend-tests:
    name: 后端测试
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y libta-lib-dev

      - name: 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: 运行后端测试
        run: |
          pytest tests/backend/ -v --cov=src --cov-report=xml

  # 前端测试
  frontend-tests:
    name: 前端测试
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/dashboard/static

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 运行前端测试
        run: npm run test:coverage

      - name: 构建前端
        run: npm run build

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: src/dashboard/static/dist/

  # 构建Docker镜像
  build-and-push:
    name: 构建Docker镜像
    runs-on: ubuntu-latest
    needs: [code-quality, backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 构建和推送Docker镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: codextrading/codex-dashboard:latest
