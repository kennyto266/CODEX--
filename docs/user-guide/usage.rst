使用指南
========

系统功能概览
------------

港股量化交易系统提供以下核心功能：

* 策略回测和优化
* 实时数据监控
* 智能体协同工作
* 投资组合管理
* 风险控制
* Web界面管理

策略回测
--------

支持的策略类型
~~~~~~~~~~~~~~

系统支持11种技术指标策略：

1. **MA (移动平均)**
   * 简单移动平均 (SMA)
   * 指数移动平均 (EMA)
   * 加权移动平均 (WMA)

2. **RSI (相对强弱指数)**
   * 超买超卖信号
   * 背离分析

3. **MACD (指数平滑异同移动平均)**
   * 趋势跟踪
   * 动量分析

4. **BB (布林带)**
   * 波动率分析
   * 价格通道

5. **KDJ (随机指标)**
   * 短期买卖点
   * 超买超卖判断

6. **CCI (商品通道指数)**
   * 周期趋势分析

7. **ADX (平均趋向指数)**
   * 趋势强度测量

8. **ATR (平均真实波幅)**
   * 波动率指标
   * 止损设置

9. **OBV (能量潮)**
   * 成交量分析
   * 量价配合

10. **Ichimoku (一目均衡表)**
    * 多维度趋势分析
    * 支撑阻力位

11. **Parabolic SAR**
    * 趋势反转点
    * 止损止盈

回测参数设置
~~~~~~~~~~~~

**基础参数**

.. code-block:: text

   股票代码: 0700.HK, 0388.HK, 0939.HK等
   开始日期: 2020-01-01
   结束日期: 2023-01-01
   初始资金: 100,000 (港币)

**策略参数示例**

.. list-table::
   :header-rows: 1
   :widths: 20 20 20 40

   * - 策略
     - 参数
     - 默认值
     - 说明
   * - KDJ
     - k_period
     - 9
     - K值计算周期
   * - KDJ
     - d_period
     - 3
     - D值平滑周期
   * - KDJ
     - oversold
     - 20
     - 超卖阈值
   * - KDJ
     - overbought
     - 80
     - 超买阈值
   * - RSI
     - period
     - 14
     - RSI计算周期
   * - MACD
     - fast
     - 12
     - 快线周期
   * - MACD
     - slow
     - 26
     - 慢线周期
   * - MACD
     - signal
     - 9
     - 信号线周期

回测结果分析
~~~~~~~~~~~~

**关键指标**

.. code-block:: text

   总收益率: 15.67%
   ├─ 基准收益: 8.23%
   └─ 超额收益: 7.44%

   年化收益率: 8.32%
   ├─ 年化波动率: 12.45%
   └─ 夏普比率: 1.23

   最大回撤: -5.45%
   ├─ 回撤开始: 2022-03-15
   ├─ 回撤结束: 2022-04-20
   └─ 恢复时间: 35天

   交易统计
   ├─ 交易次数: 48次
   ├─ 胜率: 62.5%
   ├─ 平均盈利: +2.3%
   └─ 平均亏损: -1.8%

**图表分析**

1. **收益曲线图**
   ~~~~~~~~~~~~~

   展示策略收益与基准的对比

2. **回撤分析图**
   ~~~~~~~~~~~~~

   显示策略的下行风险

3. **月度收益热力图**
   ~~~~~~~~~~~~~~~~

   按月展示收益分布

4. **交易记录表**
   ~~~~~~~~~~~~~

   详细记录每笔交易

参数优化
~~~~~~~~

**优化方法**

1. **网格搜索**
   ~~~~~~~~~~

   系统遍历所有参数组合，寻找最优解。

2. **遗传算法**
   ~~~~~~~~~~

   使用遗传算法快速收敛到最优解。

3. **贝叶斯优化**
   ~~~~~~~~~~~~

   智能搜索，减少计算量。

**优化目标**

.. list-table::
   :header-rows: 1

   * - 目标函数
     - 描述
   * - 最大化夏普比率
     * 风险调整后收益
   * - 最大化总收益
     * 绝对收益最大化
   * - 最小化最大回撤
     * 风险控制优先
   * - 最大化胜率
     * 交易胜率最大化

**优化示例**

.. code-block:: text

   优化策略: KDJ
   优化目标: 最大化夏普比率
   参数范围:
     - k_period: [5, 30] (步长5)
     - d_period: [3, 5] (步长1)
     - oversold: [20, 40] (步长5)
     - overbought: [60, 80] (步长5)

   总组合数: 400
   并行线程: 8
   预计时间: 10-15分钟

实时数据监控
------------

监控界面功能
~~~~~~~~~~~~

1. **市场概览**
   ~~~~~~~~~~

   显示主要指数和热门股票：

   .. code-block:: text

      恒生指数: 17,250.50 (+1.2%)
      恒生科技: 3,450.80 (+2.3%)
      0700.HK: 350.00 (+0.8%)
      0388.HK: 280.50 (+1.5%)

2. **实时行情**
   ~~~~~~~~~~

   * 分时走势图
   * K线图
   * 成交量图
   * 技术指标图

3. **智能体状态**
   ~~~~~~~~~~

   显示7个AI Agent的运行状态：

   .. code-block:: text

      ✓ Coordinator: 正常运行 (CPU: 12%, 内存: 512MB)
      ✓ Data Scientist: 正常运行 (CPU: 25%, 内存: 1.2GB)
      ✓ Quantitative Analyst: 正常运行 (CPU: 18%, 内存: 800MB)
      ✓ Portfolio Manager: 正常运行 (CPU: 8%, 内存: 640MB)
      ✓ Research Analyst: 正常运行 (CPU: 15%, 内存: 920MB)
      ✓ Risk Analyst: 正常运行 (CPU: 10%, 内存: 480MB)
      ✓ Quantitative Engineer: 正常运行 (CPU: 5%, 内存: 320MB)

告警设置
~~~~~~~~

**告警类型**

1. **价格告警**
   ~~~~~~~~~~

   .. code-block:: text

      触发条件: 0700.HK突破400港币
      告警级别: 信息
      通知方式: Web弹窗 + 邮件

2. **技术指标告警**
   ~~~~~~~~~~~~~~

   .. code-block:: text

      触发条件: KDJ出现金叉信号
      告警级别: 重要
      通知方式: Web弹窗 + 短信

3. **风险告警**
   ~~~~~~~~~~

   .. code-block:: text

      触发条件: 投资组合回撤超5%
      告警级别: 严重
      通知方式: 全渠道通知

WebSocket数据
~~~~~~~~~~~~~

实时数据通过WebSocket推送：

.. code-block:: javascript

   // 订阅市场数据
   ws.send(JSON.stringify({
       type: 'subscribe',
       channel: 'market_data',
       symbols: ['0700.HK', '0388.HK']
   }));

   // 接收数据
   ws.onmessage = (event) => {
       const data = JSON.parse(event.data);
       if (data.type === 'market_data') {
           updatePrice(data.symbol, data.data);
       }
   };

投资组合管理
------------

组合创建
~~~~~~~~

.. code-block:: text

   投资组合名称: 港股核心组合
   初始资金: 1,000,000 港币
   风险偏好: 中等
   投资目标: 稳健增值

持仓管理
~~~~~~~~

.. code-block:: text

   股票代码 | 数量 | 成本价 | 现价 | 盈亏 | 占比
   0700.HK | 1000 | 350.0 | 352.0 | +2,000 | 35.2%
   0388.HK | 500  | 280.0 | 280.5 | +250  | 28.1%
   0939.HK | 2000 | 5.80  | 5.85  | +100  | 23.4%
   现金    | -    | -     | -     | -     | 13.3%

再平衡策略
~~~~~~~~~~

1. **定期再平衡**
   ~~~~~~~~~~~~

   每月/季度调整一次，恢复目标配置。

2. **阈值再平衡**
   ~~~~~~~~~~~~

   当资产偏离目标配置超过5%时触发。

3. **动态再平衡**
   ~~~~~~~~~~~~

   根据市场环境和策略信号调整。

风险控制
--------

风险指标
~~~~~~~~

1. **VaR (风险价值)**
   ~~~~~~~~~~~~~~

   95%置信度下，单日最大损失可能为3.2万元。

2. **CVaR (条件风险价值)**
   ~~~~~~~~~~~~~~~~~~

   超过VaR的平均损失为4.8万元。

3. **最大回撤**
   ~~~~~~~~~~

   历史最大回撤为-8.5%，发生在2022年3月。

4. **贝塔系数**
   ~~~~~~~~~~

   组合相对恒生指数的贝塔为0.85。

风险控制措施
~~~~~~~~~~~~

1. **仓位控制**
   ~~~~~~~~~~

   .. code-block:: text

      单只股票最大仓位: 40%
      行业最大仓位: 60%
      总仓位限制: 95%

2. **止损策略**
   ~~~~~~~~~~

   .. code-block:: text

      组合止损: -10%
      单股止损: -8%
      动态止损: 根据ATR调整

3. **对冲策略**
   ~~~~~~~~~~

   使用恒生指数期货对冲系统性风险。

智能体协同
----------

Agent工作流程
~~~~~~~~~~~~~

1. **Data Scientist**
   ~~~~~~~~~~~~~~~

   .. code-block:: text

      职责: 数据分析和异常检测
      工作内容:
        - 收集市场数据
        - 数据清洗和预处理
        - 异常数据检测和修复
        - 生成数据质量报告

2. **Quantitative Analyst**
   ~~~~~~~~~~~~~~~~~~~~~

   .. code-block:: text

      职责: 量化模型开发
      工作内容:
        - 开发交易策略
        - 回测验证
        - 参数优化
        - 策略评估

3. **Coordinator**
   ~~~~~~~~~~~

   .. code-block:: text

      职责: 工作流协调
      工作内容:
        - 分配任务给各Agent
        - 监控任务执行
        - 处理Agent间通信
        - 异常处理和恢复

4. **Portfolio Manager**
   ~~~~~~~~~~~~~~~~~~

   .. code-block:: text

      职责: 投资组合管理
      工作内容:
        - 资产配置
        - 风险预算
        - 组合再平衡
        - 绩效归因

5. **Risk Analyst**
   ~~~~~~~~~~~~~

   .. code-block:: text

      职责: 风险评估和控制
      工作内容:
        - 风险指标计算
        - 压力测试
        - 风险告警
        - 对冲建议

6. **Research Analyst**
   ~~~~~~~~~~~~~~~~~

   .. code-block:: text

      职责: 策略研究
      工作内容:
        - 市场研究
        - 策略改进
        - 新策略开发
        - 文献调研

7. **Quantitative Engineer**
   ~~~~~~~~~~~~~~~~~~~~~

   .. code-block:: text

      职责: 系统性能优化
      工作内容:
        - 代码性能调优
        - 系统监控
        - 故障诊断
        - 技术升级

Agent间通信
~~~~~~~~~~~

使用消息队列实现Agent间通信：

.. code-block:: python

   # 发送消息
   await agent_manager.send_message(
       from_agent="quantitative_analyst",
       to_agent="portfolio_manager",
       message_type="STRATEGY_SIGNAL",
       content={
           "symbol": "0700.HK",
           "action": "BUY",
           "confidence": 0.85
       }
   )

   # 接收消息
   @message_handler("STRATEGY_SIGNAL")
   async def handle_signal(self, message):
       # 处理交易信号
       pass

导出和报告
----------

报告类型
~~~~~~~~

1. **回测报告**
   ~~~~~~~~~~

   完整的策略回测分析报告：

   .. code-block:: text

      文件格式: PDF
      包含内容:
        - 执行摘要
        - 策略说明
        - 回测结果
        - 风险分析
        - 改进建议

2. **投资组合报告**
   ~~~~~~~~~~~~~~

   投资组合定期报告：

   .. code-block:: text

      文件格式: PDF, Excel
      包含内容:
        - 组合概况
        - 持仓明细
        - 绩效归因
        - 风险分析

3. **数据报表**
   ~~~~~~~~~~

   各类数据导出：

   .. code-block:: text

      交易记录: CSV, Excel
      市场数据: JSON, CSV
      系统日志: TXT, JSON

导出操作
~~~~~~~~

1. **通过Web界面**
   ~~~~~~~~~~~~~~

   在相应页面点击"导出"按钮。

2. **通过API**
   ~~~~~~~~~

   .. code-block:: bash

      curl -X GET "http://localhost:8001/api/v1/backtest/history" \
           -H "Authorization: Bearer <token>" \
           --output results.json

3. **通过命令行**
   ~~~~~~~~~~~~

   .. code-block:: bash

      python scripts/export_backtest_results.py \
          --output report.pdf \
          --backtest-id bt_123456

最佳实践
--------

回测建议
~~~~~~~~

1. **足够的数据量**
   ~~~~~~~~~~~~~~

   至少使用3-5年历史数据。

2. **样本内外分离**
   ~~~~~~~~~~~~~~

   用前70%数据优化，后30%数据验证。

3. **考虑交易成本**
   ~~~~~~~~~~~~~~

   包含手续费、滑点等成本。

4. **多市场环境测试**
   ~~~~~~~~~~~~~~~

   包含牛市、熊市、震荡市。

实盘交易建议
~~~~~~~~~~~

1. **小额开始**
   ~~~~~~~~~~

   先用小资金验证策略。

2. **逐步加仓**
   ~~~~~~~~~~

   策略稳定后再增加资金。

3. **严格风控**
   ~~~~~~~~~~

   遵守止损和仓位限制。

4. **持续监控**
   ~~~~~~~~~~

   密切关注策略表现。

日常操作
~~~~~~~~

1. **每日检查**
   ~~~~~~~~~~

   * 查看系统健康状态
   * 检查告警信息
   * 监控持仓变化

2. **每周总结**
   ~~~~~~~~~~

   * 回顾交易表现
   * 分析市场变化
   * 优化策略参数

3. **每月评估**
   ~~~~~~~~~~

   * 全面绩效评估
   * 风险指标检查
   * 调整投资计划
