# æ¸¯è‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿ - æ–‡æ¡£æ„å»ºç³»ç»Ÿ
#
# æä¾›ä¾¿æ·çš„æ–‡æ¡£æ„å»ºå‘½ä»¤
#
# ä½¿ç”¨æ–¹æ³•:
#   make help        - æ˜¾ç¤ºå¸®åŠ©
#   make all         - æ„å»ºæ‰€æœ‰æ–‡æ¡£
#   make sphinx      - æ„å»ºSphinxæ–‡æ¡£
#   make api         - ç”ŸæˆAPIæ–‡æ¡£
#   make clean       - æ¸…ç†æ„å»ºæ–‡ä»¶
#

.PHONY: help all sphinx mkdocs api rust coverage clean serve

# é»˜è®¤ç›®æ ‡
help:
	@echo "æ¸¯è‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿ - æ–‡æ¡£æ„å»ºå‘½ä»¤"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  help       - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo "  all        - æ„å»ºæ‰€æœ‰æ–‡æ¡£ï¼ˆé»˜è®¤ï¼‰"
	@echo "  sphinx     - æ„å»ºSphinxæ–‡æ¡£"
	@echo "  mkdocs     - æ„å»ºMkDocsæ–‡æ¡£"
	@echo "  api        - ç”ŸæˆAPIæ–‡æ¡£"
	@echo "  rust       - æ„å»ºRustæ–‡æ¡£"
	@echo "  coverage   - ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ–‡æ¡£"
	@echo "  clean      - æ¸…ç†æ‰€æœ‰æ„å»ºæ–‡ä»¶"
	@echo "  serve      - å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make api           - ä»…ç”ŸæˆAPIæ–‡æ¡£"
	@echo "  make all           - æ„å»ºæ‰€æœ‰æ–‡æ¡£"
	@echo "  make clean all     - æ¸…ç†åé‡æ–°æ„å»º"

# æ„å»ºæ‰€æœ‰æ–‡æ¡£
all:
	python scripts/build_docs.py --all

# æ„å»ºSphinxæ–‡æ¡£
sphinx:
	python scripts/build_docs.py --sphinx

# æ„å»ºMkDocsæ–‡æ¡£
mkdocs:
	python scripts/build_docs.py --mkdocs

# ç”ŸæˆAPIæ–‡æ¡£
api:
	python scripts/generate_api_docs.py

# æ„å»ºRustæ–‡æ¡£
rust:
	python scripts/build_docs.py --rust

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ–‡æ¡£
coverage:
	python scripts/build_docs.py --coverage

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf docs/_build/
	rm -rf site/
	rm -rf docs/api/generated/
	rm -rf docs/coverage/
	rm -rf htmlcov/
	rm -rf docs/rust/
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¯åŠ¨æœ¬åœ°æ–‡æ¡£æœåŠ¡å™¨
serve:
	@echo "ğŸš€ å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨..."
	@echo "è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://localhost:8000"
	cd docs/_build/html && python -m http.server 8000

# æ£€æŸ¥æ–‡æ¡£è´¨é‡
lint:
	@echo "ğŸ” æ£€æŸ¥æ–‡æ¡£è´¨é‡..."
	@echo "æ£€æŸ¥RSTæ–‡ä»¶..."
	find docs -name "*.rst" -exec rst2html {} /dev/null \; 2>/dev/null || echo "âš ï¸  å‘ç°RSTè¯­æ³•é”™è¯¯"
	@echo "æ£€æŸ¥Markdownæ–‡ä»¶..."
	find docs -name "*.md" -exec echo "æ£€æŸ¥: {}" \;
	@echo "âœ… æ–‡æ¡£è´¨é‡æ£€æŸ¥å®Œæˆ"

# ç”ŸæˆPDFæ–‡æ¡£
pdf:
	@echo "ğŸ“„ ç”ŸæˆPDFæ–‡æ¡£..."
	@echo "æ³¨æ„: PDFç”Ÿæˆéœ€è¦å®‰è£…LaTeX"
	@which pdflatex >/dev/null || (echo "âŒ æœªå®‰è£…LaTeXï¼Œè¯·å…ˆå®‰è£…: sudo apt-get install texlive-latex-base" && exit 1)
	sphinx-build -b latex docs docs/_build/latex
	cd docs/_build/latex && make

# æ£€æŸ¥æ–‡æ¡£é“¾æ¥
linkcheck:
	@echo "ğŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æ¥..."
	sphinx-build -b linkcheck docs docs/_build/linkcheck
	@echo "âœ… é“¾æ¥æ£€æŸ¥å®Œæˆ"

# è‡ªåŠ¨æ ¼å¼åŒ–æ–‡æ¡£
fmt:
	@echo "âœ¨ æ ¼å¼åŒ–æ–‡æ¡£..."
	@echo "æ ¼å¼åŒ–RSTæ–‡ä»¶..."
	find docs -name "*.rst" -exec python -m doc8 {} \;
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

# å®‰è£…æ–‡æ¡£ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…æ–‡æ¡£ä¾èµ–..."
	pip install -r docs_requirements.txt
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# æ„å»ºå¹¶éƒ¨ç½²åˆ°GitHub Pages
deploy:
	@echo "ğŸš€ éƒ¨ç½²æ–‡æ¡£åˆ°GitHub Pages..."
	@if [ -z "$(GH_TOKEN)" ]; then \
		echo "âŒ è¯·è®¾ç½®GH_TOKENç¯å¢ƒå˜é‡"; \
		exit 1; \
	fi
	git checkout -B gh-pages
	cp -r docs/_build/html/* .
	touch .nojekyll
	git add .
	git commit -m "docs: Update documentation"
	git push https://$(GH_TOKEN)@github.com/$(GITHUB_REPO) gh-pages
	git checkout main
	@echo "âœ… éƒ¨ç½²å®Œæˆ"

# ç”Ÿæˆæ–‡æ¡£å˜æ›´æ—¥å¿—
changelog:
	@echo "ğŸ“ ç”Ÿæˆæ–‡æ¡£å˜æ›´æ—¥å¿—..."
	@echo "åŸºäºGitæäº¤å†å²ç”Ÿæˆæ–‡æ¡£å˜æ›´æ—¥å¿—..."
	@echo "è¯·æ‰‹åŠ¨æŸ¥çœ‹: git log --oneline --grep='docs'"

# éªŒè¯æ–‡æ¡£å®Œæ•´æ€§
verify:
	@echo "âœ… éªŒè¯æ–‡æ¡£å®Œæ•´æ€§..."
	@echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
	@test -f docs/index.rst || (echo "âŒ ç¼ºå°‘ docs/index.rst" && exit 1)
	@test -f docs/conf.py || (echo "âŒ ç¼ºå°‘ docs/conf.py" && exit 1)
	@test -d docs/api || (echo "âŒ ç¼ºå°‘ docs/api ç›®å½•" && exit 1)
	@test -d docs/user-guide || (echo "âŒ ç¼ºå°‘ docs/user-guide ç›®å½•" && exit 1)
	@test -d docs/developer-guide || (echo "âŒ ç¼ºå°‘ docs/developer-guide ç›®å½•" && exit 1)
	@test -d docs/architecture || (echo "âŒ ç¼ºå°‘ docs/architecture ç›®å½•" && exit 1)
	@echo "âœ… æ–‡æ¡£å®Œæ•´æ€§éªŒè¯é€šè¿‡"

# ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡
stats:
	@echo "ğŸ“Š ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡..."
	@echo ""
	@echo "RSTæ–‡ä»¶:"
	@find docs -name "*.rst" | wc -l | xargs echo "  æ•°é‡:"
	@echo ""
	@echo "Markdownæ–‡ä»¶:"
	@find docs -name "*.md" | wc -l | xargs echo "  æ•°é‡:"
	@echo ""
	@echo "æ–‡æ¡£æ€»è¡Œæ•°:"
	@find docs -name "*.rst" -o -name "*.md" | xargs wc -l | tail -1
	@echo ""
	@echo "ä»£ç ç¤ºä¾‹:"
	@find docs -name "*.py" -o -name "*.sh" -o -name "*.js" | wc -l | xargs echo "  æ–‡ä»¶æ•°:"
