# 代碼審查指南
## Sprint 0 - US-002 Task 2.5

### 目錄
1. [代碼審查概述](#代碼審查概述)
2. [審查者角色](#審查者角色)
3. [審查流程](#審查流程)
4. [審查檢查清單](#審查檢查清單)
5. [審查標準](#審查標準)
6. [審查工具](#審查工具)
7. [最佳實踐](#最佳實踐)
8. [常見問題](#常見問題)

---

## 代碼審查概述

### 目的
- **提高代碼質量**: 發現錯誤和改進點
- **知識共享**: 團隊成員互相學習
- **一致性**: 確保代碼符合團隊標準
- **安全性**: 識別潛在安全漏洞
- **可維護性**: 確保代碼易於理解和維護

### 審查原則
1. **及時性**: 24小時內完成審查
2. **建設性**: 提供改進建議而非批評
3. **協作性**: 共同解決問題
4. **客觀性**: 基於標準和證據
5. **學習性**: 將審查視為學習機會

### 審查類型

#### 1. 設計審查 (Design Review)
- 檢查架構設計
- 驗證設計模式
- 評估擴展性
- 檢查依賴關係

#### 2. 代碼審查 (Code Review)
- 檢查代碼質量
- 驗證功能正確性
- 評估可讀性
- 檢查錯誤處理

#### 3. 安全審查 (Security Review)
- 識別安全漏洞
- 檢查輸入驗證
- 評估權限控制
- 檢查敏感信息處理

#### 4. 性能審查 (Performance Review)
- 識別性能問題
- 檢查算法效率
- 評估資源使用
- 檢查併發處理

---

## 審查者角色

### 1. 主要審查者 (Primary Reviewer)
**職責**:
- 負責整體審查質量
- 協調其他審查者
- 最終決定是否批准

**要求**:
- 熟悉相關代碼區域
- 具備豐富開發經驗
- 責任心強

### 2. 專家審查者 (Expert Reviewer)
**職責**:
- 檢查特定領域（如安全性、性能）
- 提供專業建議
- 驗證特殊需求

**要求**:
- 領域專家
- 相關認證或經驗

### 3. 觀察者 (Observer)
**職責**:
- 學習和了解代碼
- 可以提供建議
- 不參與最終決定

**要求**:
- 對代碼感興趣
- 願意學習

### 4. Code Owner
**職責**:
- 必須審查其負責的代碼
- 確保代碼符合標準
- 維護代碼質量

**要求**:
- 被指定為 Code Owner
- 熟悉代碼區域

---

## 審查流程

### Step 1: PR 創建

**提交者準備**:
```markdown
## PR 描述模板
### 變更摘要
簡要描述本次變更

### 類型
- [ ] 新功能 (feat)
- [ ] 修復 (fix)
- [ ] 重構 (refactor)
- [ ] 文檔 (docs)
- [ ] 測試 (test)

### 測試
- [ ] 單元測試通過
- [ ] 集成測試通過
- [ ] 覆蓋率 >= 80%
- [ ] 手動測試完成

### 檢查清單
- [ ] 遵循編碼規範
- [ ] 添加了 docstring
- [ ] 考慮了邊界情況
- [ ] 處理了錯誤情況
- [ ] 更新了文檔
```

### Step 2: 自動檢查

**CI/CD 管道**:
1. ✅ 編譯檢查
2. ✅ 單元測試
3. ✅ 集成測試
4. ✅ 代碼覆蓋率
5. ✅ Linting (black, isort, flake8)
6. ✅ 類型檢查 (mypy)
7. ✅ 安全檢查 (bandit)
8. ✅ 依賴檢查

**檢查失敗** → PR 標記為 "檢查失敗"
**檢查通過** → 進入人工審查

### Step 3: 分配審查者

**自動分配**:
- 根據 CODEOWNERS 文件
- 優先分配給相關領域專家

**手動分配**:
- 提交者指定審查者
- 團隊負責人分配

### Step 4: 審查執行

**審查時間線**:
- T+0: PR 創建，自動檢查開始
- T+4h: 自動檢查完成，分配審查者
- T+24h: 審查完成（最晚）
- T+48h: 需要時進行第二次審查

**審查步驟**:
1. 閱讀 PR 描述和變更摘要
2. 檢查整體設計
3. 逐行審查代碼
4. 檢查測試用例
5. 驗證文檔更新
6. 運行測試（如需要）
7. 提供反饋

### Step 5: 反饋處理

**提交者處理反饋**:
1. 回應每條評論
2. 進行必要修改
3. 重新提交
4. 請求再次審查

**反饋類型**:
- ✅ **贊成**: "Looks good to me"
- 💡 **建議**: "Consider doing X"
- ❓ **問題**: "Why did you do X?"
- ❌ **阻擋**: "This needs to be fixed"

### Step 6: 批准與合併

**批准條件**:
- 所有檢查通過
- 所有評論已處理
- 至少一人批准
- Code Owner 批准（如適用）

**合併方式**:
- **Squash and Merge** (推薦): 保持歷史整潔
- **Rebase and Merge**: 線性歷史
- **Merge**: 保留所有分支歷史

---

## 審查檢查清單

### 通用檢查

#### PR 描述
- [ ] PR 標題清晰，遵循 Conventional Commits
- [ ] PR 描述完整，包含變更摘要
- [ ] 提供了測試結果
- [ ] 包含了相關鏈接和截圖

#### 代碼質量
- [ ] 代碼可讀性強
- [ ] 遵循團隊編碼規範
- [ ] 函數/類命名清晰
- [ ] 變量命名有意義
- [ ] 代碼註釋充分
- [ ] 沒有冗餘代碼

#### 架構設計
- [ ] 遵循5層架構
- [ ] 模塊間依賴合理
- [ ] 接口設計清晰
- [ ] 避免過度設計
- [ ] 考慮了可擴展性
- [ ] 遵循 SOLID 原則

#### 功能正確性
- [ ] 代碼實現符合需求
- [ ] 處理了邊界情況
- [ ] 錯誤處理完善
- [ ] 資源管理正確
- [ ] 併發處理安全

### 具體檢查項目

#### 1. 數據層 (Data Layer)
- [ ] Repository 模式實現正確
- [ ] 數據庫查詢優化
- [ ] 連接管理正確
- [ ] 事務處理適當
- [ ] SQL 注入防護
- [ ] 查詢參數化

#### 2. 業務邏輯層 (Business Layer)
- [ ] 業務規則正確
- [ ] 驗證邏輯完整
- [ ] 計算邏輯準確
- [ ] 狀態管理清晰
- [ ] 事件處理正確

#### 3. API 層 (API Layer)
- [ ] RESTful 設計正確
- [ ] HTTP 狀態碼正確
- [ ] 輸入驗證嚴格
- [ ] 錯誤響應標準化
- [ ] API 文檔完整
- [ ] 版本控制合理

#### 4. 測試
- [ ] 單元測試覆蓋 >= 80%
- [ ] 集成測試通過
- [ ] 測試用例完整
- [ ] Mock 使用恰當
- [ ] 測試名稱清晰
- [ ] 邊界情況覆蓋

#### 5. 安全
- [ ] 輸入驗證
- [ ] SQL 注入防護
- [ ] XSS 防護
- [ ] CSRF 防護
- [ ] 權限控制
- [ ] 敏感信息不硬編碼
- [ ] 日誌不記錄敏感數據

#### 6. 性能
- [ ] 避免 N+1 查詢
- [ ] 適當使用索引
- [ ] 緩存策略合理
- [ ] 避免不必要計算
- [ ] 內存使用優化
- [ ] 併發安全

#### 7. 可維護性
- [ ] 代碼結構清晰
- [ ] 模塊化程度高
- [ ] 依賴關係簡單
- [ ] 配置外部化
- [ ] 錯誤可追溯
- [ ] 監控和日誌完善

---

## 審查標準

### 代碼質量評分

#### A 級 (優秀)
- 超出預期，無需修改
- 代碼質量高，設計優雅
- 測試覆蓋完整
- 文檔完整

#### B 級 (良好)
- 符合預期，有小幅改進空間
- 代碼質量良好，少量問題
- 測試覆蓋基本完整
- 文檔基本完整

#### C 級 (一般)
- 基本符合預期，需要修改
- 存在明顯問題
- 測試覆蓋不足
- 文檔缺失

#### D 級 (不通過)
- 不符合預期，需要重寫
- 存在嚴重問題
- 無測試或測試失敗
- 無文檔

### 審查決策

#### ✅ **批准 (Approve)**
所有檢查通過，無阻擋性問題
```
LGTM (Looks Good To Me)
Approved ✓
```

#### 💡 **建議 (Request Changes)**
有改進建議，但非阻擋性
```
Consider addressing the following:
- Issue 1
- Issue 2
Otherwise, looks good!
Approve ✓
```

#### ❌ **拒絕 (Request Changes)**
存在阻擋性問題，需要修改
```
This PR has some issues that need to be addressed:

**Blocking Issues:**
1. Security issue in line X
2. Missing error handling in Y

Please fix these before we can merge.
Request Changes ✗
```

#### ❓ **評論 (Comment)**
有問題需要澄清
```
I have a question about this implementation:
Why did you choose X over Y?
```

---

## 審查工具

### GitHub 審查

#### 基本操作
```bash
# 創建 PR
gh pr create \
  --title "feat(US-XXX): 標題" \
  --body "PR 描述" \
  --base develop \
  --head feature/US-XXX

# 審查 PR
gh pr review --approve PR_NUMBER
gh pr review --comment -b "評論內容" PR_NUMBER
gh pr review --request-changes -b "修改建議" PR_NUMBER

# 檢查 PR 狀態
gh pr view PR_NUMBER --web
```

#### 審查技巧

**1. 使用 GitHub 線程**
- 對每個問題創建線程
- 標記已解決的線程
- 避免重複問題

**2. 代碼建議**
```markdown
suggestion: 您可以在這裡使用更高效的方式：

```python
# 當前代碼
result = []
for item in items:
    result.append(process(item))

# 建議改進
result = [process(item) for item in items]
```
```

**3. 截圖和 GIF**
- 使用截圖說明問題
- 使用 GIF 展示期望行為
- 避免文字描述歧義

### GitLab 審查

#### 基本操作
```bash
# 創建 Merge Request
glab mr create \
  --title "feat(US-XXX): 標題" \
  --description "MR 描述" \
  --target-branch develop \
  --source-branch feature/US-XXX

# 審查 Merge Request
glab mr approve MR_ID
glab mr comment -b "評論內容" MR_ID
```

### VS Code 擴展

#### 推薦擴展
1. **GitLens**: 查看 git 歷史和註釋
2. **Git Graph**: 可視化 git 圖表
3. **Review Board**: 集成 Review Board
4. **Code Review**: GitHub 審查擴展

---

## 最佳實踐

### 提交者最佳實踐

#### 1. 提交前自檢
```bash
# 運行所有檢查
pre-commit run --all-files
pytest -m "not slow"
pytest --cov=src --cov-fail-under=80

# 檢查代碼規範
black --check .
isort --check-only .
flake8 .

# 更新文檔
git diff --stat
```

#### 2. PR 大小控制
**建議**:
- PR 變更 < 400 行
- PR 審查時間 < 1 小時
- 一個 PR 一個功能

**大 PR 處理**:
- 拆分成多個小 PR
- 使用草稿 PR 討論設計
- 提前與審查者溝通

#### 3. 響應評論
- 24小時內回應評論
- 感謝每個建議
- 詳細解釋決策
- 提供替代方案
- 標記已解決

### 審查者最佳實踐

#### 1. 審查前準備
- 了解 PR 背景
- 閱讀相關文檔
- 查看設計討論
- 準備測試環境

#### 2. 審查策略
- 先看整體設計
- 再看實現細節
- 最後看測試和文檔
- 優先檢查關鍵路徑

#### 3. 提供反饋
- 具體且可行
- 給出替代方案
- 解釋原因
- 區分阻擋性和非阻擋性
- 讚賞好代碼

#### 4. 時間管理
- 設置審查時間塊
- 避免多任務
- 集中注意力
- 按優先級審查

---

## 常見問題

### Q1: 如何處理大型 PR？
```markdown
1. 與提交者溝通，建議拆分
2. 如果無法拆分，分階段審查
3. 先審查關鍵模塊
4. 安排專門時間塊
5. 請求更多審查者
```

### Q2: 如何處理不同意見？
```markdown
1. 保持尊重和客觀
2. 基於標準和數據討論
3. 尋求第三方意見
4. 團隊負責人決定
5. 記錄決策原因
```

### Q3: 如何審查陌生代碼？
```markdown
1. 了解業務背景
2. 閱讀相關文檔
3. 運行測試和演示
4. 詢問相關人員
5. 檢查設計文檔
```

### Q4: 如何處理審查積壓？
```markdown
1. 優先審查阻塞性 PR
2. 設置每日審查時間
3. 與團隊協調資源
4. 標記非緊急 PR
5. 尋求幫助
```

### Q5: 如何提高審查效率？
```markdown
1. 使用自動化工具
2. 集中審查相似 PR
3. 使用審查清單
4. 建立模板
5. 持續學習
```

---

## 審查指標

### 量化指標

#### 時間指標
- **平均審查時間**: < 24 小時
- **首次響應時間**: < 4 小時
- **審查完成時間**: < 48 小時

#### 質量指標
- **PR 批准率**: > 80%
- **首次審查通過率**: > 60%
- **代碼覆蓋率**: >= 80%
- **測試通過率**: 100%

#### 效率指標
- **審查吞吐量**: 每人每天 2-3 個 PR
- **審查覆蓋率**: 100% (所有 PR)
- **審查者參與率**: > 80%

### 質化指標

#### 代碼質量
- Bug 發現率
- 性能問題發現率
- 安全問題發現率
- 設計問題發現率

#### 團隊滿意度
- 審查滿意度調查
- 代碼質量改進
- 知識共享程度
- 團隊協作效率

---

## 總結

代碼審查是提高代碼質量、促進團隊協作和知識共享的重要實踐。遵循本指南，確保：

✅ 審查流程清晰高效
✅ 審查標準一致
✅ 反饋及時建設性
✅ 代碼質量持續提升
✅ 團隊協作更緊密

記住：**審查是協作，不是批評。目標是共同創建優秀的代碼。**

---

**文檔版本**: 1.0.0
**更新日期**: 2025-11-05
**維護者**: Sprint 0 團隊
