<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODEX Trading Dashboard - æ¸¯è‚¡é‡åŒ–äº¤æ˜“ç³»çµ±</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome Icons (å¯é¸) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- è‡ªå®šç¾©æ¨£å¼ -->
  <style>
    :root {
      --primary-color: #2563eb;
      --success-color: #16a34a;
      --danger-color: #dc2626;
      --warning-color: #ea580c;
      --info-color: #0891b2;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f9fafb;
    }

    /* å¹³æ»‘æ»¾å‹• */
    html {
      scroll-behavior: smooth;
    }

    /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* å‹•ç•« */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* åŠ è¼‰å‹•ç•« */
    @keyframes spin-slow {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .spin-slow {
      animation: spin-slow 3s linear infinite;
    }

    /* å¡ç‰‡é™°å½± */
    .card-shadow {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    .card-shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* éŸ¿æ‡‰å¼å®¹å™¨ */
    .container-responsive {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 16px;
    }

    @media (max-width: 768px) {
      .container-responsive {
        padding: 0 12px;
      }
    }
  </style>
</head>
<body>
  <!-- é é¢æ ¹ç¯€é» -->
  <div id="app" class="min-h-screen">
    <!-- åŠ è¼‰ä¸­æç¤º -->
    <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      <div class="text-center">
        <div class="mb-4">
          <svg class="spin-slow w-16 h-16 mx-auto text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­£åœ¨åŠ è¼‰å„€è¡¨æ¿</h2>
        <p class="text-gray-600">åˆå§‹åŒ– Vue æ‡‰ç”¨å’Œæ•¸æ“šé€£æ¥...</p>
        <div class="mt-4 w-48 h-2 bg-gray-200 rounded-full mx-auto overflow-hidden">
          <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-600 animate-pulse"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue 3 å’Œ Pinia -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>

  <!-- æ‡‰ç”¨åˆå§‹åŒ– -->
  <script type="module">
    // å…¨å±€è®Šé‡
    window.API_BASE_URL = 'http://localhost:8001/api';
    window.WS_BASE_URL = 'ws://localhost:8001';

    // API å·¥å…·å‡½æ•¸
    window.apiCall = async (endpoint, options = {}) => {
      try {
        const response = await fetch(window.API_BASE_URL + endpoint, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
      } catch (error) {
        console.error('API èª¿ç”¨å¤±æ•—:', error);
        throw error;
      }
    };

    // WebSocket å·¥å…·
    window.connectWebSocket = (endpoint) => {
      const url = window.WS_BASE_URL + endpoint;
      const ws = new WebSocket(url);

      ws.onopen = () => {
        console.log(`âœ… WebSocket é€£æ¥: ${endpoint}`);
      };

      ws.onerror = (error) => {
        console.error(`âŒ WebSocket éŒ¯èª¤ (${endpoint}):`, error);
      };

      ws.onclose = () => {
        console.log(`âš ï¸ WebSocket æ–·é–‹: ${endpoint}`);
      };

      return ws;
    };

    console.log('âœ… å…¨å±€ API å’Œ WebSocket å·¥å…·å·²åŠ è¼‰');
  </script>

  <!-- æ‡‰ç”¨çµ„ä»¶å’Œåˆå§‹åŒ– (é–‹ç™¼æ¨¡å¼ - ä½¿ç”¨ CDN) -->
  <script type="module">
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    const { defineStore, createPinia } = Pinia;

    // ==================== Pinia Stores ====================

    // Backtest Store
    const useBacktestStore = defineStore('backtest', () => {
      const backtests = ref({});
      const currentBacktestId = ref(null);
      const isLoading = ref(false);
      const error = ref(null);

      const currentBacktest = computed(() => {
        return backtests.value[currentBacktestId.value] || null;
      });

      const allBacktests = computed(() => {
        return Object.values(backtests.value);
      });

      const completedBacktests = computed(() => {
        return Object.values(backtests.value).filter(bt => bt.status === 'completed');
      });

      const runningBacktests = computed(() => {
        return Object.values(backtests.value).filter(bt => bt.status === 'running');
      });

      async function submitBacktest(config) {
        isLoading.value = true;
        error.value = null;

        try {
          const response = await window.apiCall('/backtest/run', {
            method: 'POST',
            body: JSON.stringify({ config })
          });

          const backtestId = response.backtest_id;
          currentBacktestId.value = backtestId;

          backtests.value[backtestId] = {
            backtest_id: backtestId,
            config,
            status: 'pending',
            progress: 0,
            created_at: new Date(),
            started_at: null,
            completed_at: null,
            results: null
          };

          // é–‹å§‹è¼ªè©¢ç‹€æ…‹
          pollBacktestStatus(backtestId);
          return backtestId;
        } catch (err) {
          error.value = err.message;
          console.error('æäº¤å›æ¸¬å¤±æ•—:', err);
          throw err;
        } finally {
          isLoading.value = false;
        }
      }

      async function pollBacktestStatus(backtestId, interval = 2000) {
        const maxAttempts = 300;
        let attempts = 0;

        const pollInterval = setInterval(async () => {
          attempts++;

          try {
            const data = await window.apiCall(`/backtest/status/${backtestId}`);
            backtests.value[backtestId] = {
              ...backtests.value[backtestId],
              status: data.status,
              progress: data.progress,
              error_message: data.error_message
            };

            if (data.status === 'completed') {
              await fetchBacktestResults(backtestId);
              clearInterval(pollInterval);
            }
          } catch (err) {
            console.error('è¼ªè©¢å›æ¸¬ç‹€æ…‹å¤±æ•—:', err);
            if (attempts >= maxAttempts) {
              clearInterval(pollInterval);
            }
          }
        }, interval);
      }

      async function fetchBacktestResults(backtestId) {
        try {
          const data = await window.apiCall(`/backtest/results/${backtestId}`);
          backtests.value[backtestId].results = data;
          backtests.value[backtestId].completed_at = new Date();
        } catch (err) {
          console.error('ç²å–å›æ¸¬çµæœå¤±æ•—:', err);
          throw err;
        }
      }

      async function fetchBacktestList(limit = 20) {
        isLoading.value = true;
        error.value = null;

        try {
          const data = await window.apiCall(`/backtest/list?limit=${limit}`);

          data.forEach(bt => {
            backtests.value[bt.backtest_id] = {
              ...backtests.value[bt.backtest_id],
              ...bt
            };
          });

          return data;
        } catch (err) {
          error.value = err.message;
          console.error('ç²å–å›æ¸¬åˆ—è¡¨å¤±æ•—:', err);
          throw err;
        } finally {
          isLoading.value = false;
        }
      }

      function clearBacktests() {
        backtests.value = {};
        currentBacktestId.value = null;
      }

      return {
        backtests,
        currentBacktestId,
        isLoading,
        error,
        currentBacktest,
        allBacktests,
        completedBacktests,
        runningBacktests,
        submitBacktest,
        fetchBacktestResults,
        fetchBacktestList,
        clearBacktests,
        pollBacktestStatus
      };
    });

    // ==================== æ ¹çµ„ä»¶ ====================

    const RootApp = {
      template: `
        <div id="app-root" class="min-h-screen bg-gray-50">
          <!-- å°èˆªæ¬„ -->
          <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="container-responsive py-4 flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">
                  ğŸ“Š
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">CODEX Dashboard</h1>
                  <p class="text-xs text-gray-500">æ¸¯è‚¡é‡åŒ–äº¤æ˜“ç³»çµ±</p>
                </div>
              </div>
              <div class="text-sm text-gray-600">
                <span>ğŸŸ¢ å·²é€£æ¥ | v1.0.0</span>
              </div>
            </div>
          </nav>

          <!-- ä¸»å…§å®¹ -->
          <div class="container-responsive py-8">
            <BacktestPanel />
          </div>

          <!-- é è…³ -->
          <footer class="bg-white border-t border-gray-200 mt-12 py-8">
            <div class="container-responsive text-center text-gray-600 text-sm">
              <p>CODEX Trading Dashboard | å»ºé€ æ–¼ 2025</p>
              <p>ç”± Claude Code ğŸ’» ä½¿ç”¨ Vue 3 + Pinia æ§‹å»º</p>
            </div>
          </footer>
        </div>
      `,
      components: {
        BacktestPanel: {
          template: `
            <div class="space-y-6">
              <div class="flex justify-between items-center">
                <div>
                  <h2 class="text-4xl font-bold text-gray-900">ğŸ“Š å›æ¸¬ç³»çµ±</h2>
                  <p class="text-gray-600 mt-2">ç­–ç•¥æ€§èƒ½è©•ä¼°å’Œåƒæ•¸å„ªåŒ–</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">å·²å®Œæˆå›æ¸¬</p>
                  <p class="text-3xl font-bold text-blue-600">{{ backtestStore.completedBacktests.length }}</p>
                </div>
              </div>

              <!-- æ¨™ç±¤é  -->
              <div class="flex gap-2 border-b border-gray-300">
                <button
                  @click="activeTab = 'new'"
                  :class="activeTab === 'new' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-600'"
                  class="px-6 py-3 transition hover:text-blue-600"
                >
                  â• æ–°å»ºå›æ¸¬
                </button>
                <button
                  @click="activeTab = 'results'"
                  :class="activeTab === 'results' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-600'"
                  class="px-6 py-3 transition hover:text-blue-600"
                >
                  ğŸ“ˆ å›æ¸¬çµæœ ({{ backtestStore.allBacktests.length }})
                </button>
                <button
                  @click="activeTab = 'history'"
                  :class="activeTab === 'history' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-600'"
                  class="px-6 py-3 transition hover:text-blue-600"
                >
                  ğŸ“œ å›æ¸¬æ­·å²
                </button>
              </div>

              <!-- æ–°å»ºå›æ¸¬ Tab -->
              <div v-if="activeTab === 'new'" class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">å›æ¸¬é…ç½®</h3>
                <form @submit.prevent="submitBacktest" class="space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">ç­–ç•¥</label>
                      <select v-model="form.strategy_id" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">-- é¸æ“‡ç­–ç•¥ --</option>
                        <option value="moving_average_crossover">ç§»å‹•å¹³å‡ç·šäº¤å‰</option>
                        <option value="rsi_oscillator">RSI éœ‡è•©ç­–ç•¥</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">è‚¡ç¥¨</label>
                      <input v-model="form.symbol" type="text" placeholder="0700.HK" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                      <input v-model="form.start_date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                      <input v-model="form.end_date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>
                  </div>
                  <button :disabled="isSubmitting" class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded-md">
                    <span v-if="!isSubmitting">ğŸš€ é–‹å§‹å›æ¸¬</span>
                    <span v-else>â³ æäº¤ä¸­...</span>
                  </button>
                </form>
              </div>

              <!-- é‹è¡Œä¸­çš„å›æ¸¬ -->
              <div v-if="backtestStore.runningBacktests.length > 0 && activeTab === 'new'" class="space-y-4">
                <h3 class="text-xl font-bold text-gray-800">âš™ï¸ é€²è¡Œä¸­çš„å›æ¸¬</h3>
                <div
                  v-for="backtest in backtestStore.runningBacktests"
                  :key="backtest.backtest_id"
                  class="bg-white p-4 rounded-lg shadow-md"
                >
                  <div class="flex justify-between items-center mb-3">
                    <span class="font-semibold text-gray-800">{{ backtest.config.strategy_id }} - {{ backtest.config.symbol }}</span>
                    <span class="text-sm font-bold text-blue-600">{{ backtest.progress }}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div :style="{ width: backtest.progress + '%' }" class="bg-blue-600 h-2 rounded-full transition-all"></div>
                  </div>
                </div>
              </div>

              <!-- çµæœ Tab -->
              <div v-if="activeTab === 'results'" class="space-y-6">
                <div v-if="backtestStore.completedBacktests.length > 0">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">å·²å®Œæˆçš„å›æ¸¬</h3>
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div
                      v-for="backtest in backtestStore.completedBacktests"
                      :key="backtest.backtest_id"
                      @click="selectBacktest(backtest)"
                      :class="selectedBacktest?.backtest_id === backtest.backtest_id ? 'ring-2 ring-blue-600' : 'hover:shadow-lg'"
                      class="bg-white p-6 rounded-lg shadow-md cursor-pointer transition"
                    >
                      <h4 class="text-lg font-bold text-gray-800 mb-2">{{ backtest.config.strategy_id }}</h4>
                      <p class="text-sm text-gray-600 mb-3">{{ backtest.config.symbol }}</p>
                      <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                          <p class="text-gray-600">ç¸½æ”¶ç›Šç‡</p>
                          <p class="text-2xl font-bold text-green-600">{{ backtest.results?.metrics.total_return_pct.toFixed(1) }}%</p>
                        </div>
                        <div>
                          <p class="text-gray-600">Sharpe æ¯”ç‡</p>
                          <p class="text-2xl font-bold text-blue-600">{{ backtest.results?.metrics.sharpe_ratio.toFixed(2) }}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- è©³ç´°çµæœ -->
                  <div v-if="selectedBacktest" class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š è©³ç´°æŒ‡æ¨™</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">ç¸½æ”¶ç›Šç‡</p>
                        <p class="text-2xl font-bold text-green-600">{{ selectedBacktest.results?.metrics.total_return_pct.toFixed(2) }}%</p>
                      </div>
                      <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">å¹´åŒ–æ”¶ç›Šç‡</p>
                        <p class="text-2xl font-bold text-blue-600">{{ selectedBacktest.results?.metrics.annual_return_pct.toFixed(2) }}%</p>
                      </div>
                      <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">Sharpe æ¯”ç‡</p>
                        <p class="text-2xl font-bold text-purple-600">{{ selectedBacktest.results?.metrics.sharpe_ratio.toFixed(2) }}</p>
                      </div>
                      <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">æœ€å¤§å›æ’¤</p>
                        <p class="text-2xl font-bold text-red-600">{{ selectedBacktest.results?.metrics.max_drawdown.toFixed(2) }}%</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div v-else class="bg-white rounded-lg shadow-md p-12 text-center text-gray-500">
                  <p class="text-lg mb-2">ğŸ“­ æš«ç„¡å·²å®Œæˆçš„å›æ¸¬</p>
                </div>
              </div>

              <!-- æ­·å² Tab -->
              <div v-if="activeTab === 'history'" class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“œ å›æ¸¬æ­·å²</h3>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm text-gray-600">
                    <thead class="bg-gray-100 border-b">
                      <tr>
                        <th class="px-4 py-3 text-left">ç­–ç•¥</th>
                        <th class="px-4 py-3 text-left">è‚¡ç¥¨</th>
                        <th class="px-4 py-3 text-left">ç‹€æ…‹</th>
                        <th class="px-4 py-3 text-right">æ”¶ç›Šç‡</th>
                        <th class="px-4 py-3 text-right">å‰µå»ºæ™‚é–“</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="backtest in backtestStore.allBacktests" :key="backtest.backtest_id" class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">{{ backtest.config.strategy_id }}</td>
                        <td class="px-4 py-3 font-bold">{{ backtest.config.symbol }}</td>
                        <td class="px-4 py-3">
                          <span :class="statusClass(backtest.status)" class="px-2 py-1 rounded text-xs font-bold">
                            {{ statusLabel(backtest.status) }}
                          </span>
                        </td>
                        <td class="px-4 py-3 text-right" :class="backtest.results?.metrics.total_return_pct > 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold'">
                          {{ backtest.results?.metrics.total_return_pct?.toFixed(2) }}%
                        </td>
                        <td class="px-4 py-3 text-right text-xs">{{ new Date(backtest.created_at).toLocaleString() }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          `,
          setup() {
            const backtestStore = useBacktestStore();
            const activeTab = ref('new');
            const selectedBacktest = ref(null);
            const isSubmitting = ref(false);
            const form = reactive({
              strategy_id: '',
              symbol: '',
              start_date: '2023-01-01',
              end_date: '2023-12-31',
              initial_capital: 100000,
              parameters: {}
            });

            onMounted(() => {
              backtestStore.fetchBacktestList();
            });

            const submitBacktest = async () => {
              if (!form.strategy_id || !form.symbol) {
                alert('è«‹å¡«å¯«å¿…å¡«å­—æ®µ');
                return;
              }
              isSubmitting.value = true;
              try {
                await backtestStore.submitBacktest(form);
                // é‡ç½®è¡¨å–®
                form.strategy_id = '';
                form.symbol = '';
              } catch (error) {
                alert('æäº¤å¤±æ•—: ' + error.message);
              } finally {
                isSubmitting.value = false;
              }
            };

            const selectBacktest = (backtest) => {
              selectedBacktest.value = backtest;
            };

            const statusLabel = (status) => {
              const labels = {
                'pending': 'â³ ç­‰å¾…',
                'running': 'âš™ï¸ é‹è¡Œ',
                'completed': 'âœ… å®Œæˆ',
                'failed': 'âŒ å¤±æ•—'
              };
              return labels[status] || status;
            };

            const statusClass = (status) => {
              const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'running': 'bg-blue-100 text-blue-800',
                'completed': 'bg-green-100 text-green-800',
                'failed': 'bg-red-100 text-red-800'
              };
              return classes[status] || 'bg-gray-100 text-gray-800';
            };

            return {
              backtestStore,
              activeTab,
              selectedBacktest,
              isSubmitting,
              form,
              submitBacktest,
              selectBacktest,
              statusLabel,
              statusClass
            };
          }
        }
      }
    };

    // å‰µå»ºä¸¦æ›è¼‰æ‡‰ç”¨
    const app = createApp(RootApp);
    app.use(createPinia());

    // æä¾›å…¨å±€å±¬æ€§
    app.config.globalProperties.$apiCall = window.apiCall;
    app.config.globalProperties.$connectWebSocket = window.connectWebSocket;

    app.mount('#app');

    console.log('âœ… Dashboard æ‡‰ç”¨å·²åˆå§‹åŒ–ä¸¦æ›è¼‰');
  </script>

  <!-- åŠ è¼‰å®Œæˆå¾Œéš±è—åŠ è¼‰æç¤º -->
  <script>
    // ç­‰å¾…æ‡‰ç”¨åŠ è¼‰å®Œæˆå¾Œ
    window.addEventListener('load', () => {
      setTimeout(() => {
        const loader = document.querySelector('.min-h-screen.flex');
        if (loader && document.querySelector('#app-root')) {
          loader.style.display = 'none';
        }
      }, 500);
    });
  </script>
</body>
</html>
