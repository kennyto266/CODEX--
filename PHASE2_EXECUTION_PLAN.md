# Phase 2: 核心架构重构 - 执行计划

**状态**: 准备启动
**提案**: refactor-core-architecture
**任务总数**: 161 个
**计划周期**: 8 周
**从 Phase 1 学到的**: 执行速度可以比计划快 90%

---

## 📊 四阶段分解

### Phase 2.1: 基础设施设置 (第 1-2 周)
**27 个任务** | 关键路径

#### 目标
- 建立清晰的目录结构
- 定义三层架构的基础接口
- 建立测试基础设施
- 准备迁移工具

#### 关键任务
1. **目录结构** (Task 1.1.1)
   - 创建 `src/data_pipeline/sources/`
   - 创建 `src/data_pipeline/cleaners/`
   - 创建 `src/data_pipeline/processors/`
   - 创建 `src/core/`
   - 创建 `src/database/`
   - 创建 `src/visualization/`

2. **基础接口** (Tasks 1.1.2-1.1.3)
   - 定义 `IDataSource` 接口
   - 定义 `IDataCleaner` 接口
   - 定义 `IProcessor` 接口
   - 定义 `IStrategy` 接口
   - 定义 `IAnalyzer` 接口
   - 定义 `IChartBuilder` 接口

3. **测试基础设施** (Tasks 1.2.1-1.2.2)
   - 更新 pytest 配置
   - 创建 mock 数据和适配器
   - 设置测试标记

#### 时间投入
- **计划**: 14-20 小时 (2 周)
- **基于 Phase 1 经验**: 可能 2-3 小时

---

### Phase 2.2: 数据层实现 (第 3-4 周)
**45 个任务** | 统一数据源

#### 目标
- 迁移现有适配器到新的源接口
- 统一数据清理逻辑
- 实现数据处理管道
- 建立数据库操作层

#### 关键任务
1. **数据源适配器** (12 个任务)
   - HTTP API 源适配器
   - 文件数据源
   - 市场数据源
   - Yahoo Finance 源
   - Alpha Vantage 源
   - HKEX 数据源（**统一 7 个实现**）

2. **数据清理器** (10 个任务)
   - 基础数据清理器
   - 异常值检测器
   - 缺失数据处理器
   - 数据验证器

3. **数据处理器** (8 个任务)
   - 时间对齐器
   - 资产档案管理
   - 数据标准化
   - 数据聚合器

4. **数据库层** (8 个任务)
   - 数据模型定义
   - CRUD 操作
   - 查询接口
   - 事务管理

#### 时间投入
- **计划**: 20-30 小时 (2 周)
- **基于 Phase 1 经验**: 可能 3-5 小时

---

### Phase 2.3: 计算层实现 (第 5-6 周)
**56 个任务** | 统一代码重复

#### 目标
- 消除 Agent 代码重复（**合并 13 个 RealAgent 实现**）
- 统一策略框架
- 统一回测引擎
- 建立性能计算系统

#### 关键任务
1. **核心计算引擎** (15 个任务)
   - 交易信号生成器
   - 变量管理系统
   - 参数管理系统
   - 订单执行引擎
   - 错误处理器

2. **策略层** (12 个任务)
   - 基类重构
   - 技术面策略统一
   - 机器学习策略统一
   - 混合策略统一
   - 策略工厂

3. **回测引擎** (14 个任务)
   - **统一 4 个回测引擎实现**
   - 核心回测逻辑
   - 性能指标计算
   - 结果标准化
   - 回测报告生成

4. **分析模块** (10 个任务)
   - 异常检测
   - 结果标准化
   - 结果聚合
   - 性能计算
   - 风险指标

5. **Agent 层重构** (5 个任务)
   - **消除 BaseAgent + 13 个 RealAgent 的重复**
   - 统一 Agent 接口
   - 迁移到计算层 API

#### 时间投入
- **计划**: 30-40 小时 (2 周)
- **基于 Phase 1 经验**: 可能 4-6 小时

---

### Phase 2.4: 可视化层与集成 (第 7-8 周)
**33 个任务** | 完成整合

#### 目标
- 重构仪表板使用新的 API
- 完成所有集成测试
- 文档更新
- 性能验证

#### 关键任务
1. **仪表板重构** (10 个任务)
   - API 路由重构
   - WebSocket 管理器更新
   - Agent 控制面板
   - 实时监控面板
   - 数据导出服务

2. **图表与报告** (8 个任务)
   - 图表生成服务
   - 报告生成框架
   - 数据可视化
   - 交互式仪表板
   - 数据导出接口

3. **集成与测试** (10 个任务)
   - 端到端集成测试
   - 数据层 → 计算层 → 可视化层测试
   - 性能基准测试
   - 覆盖率验证
   - 文档更新

4. **最终验证** (5 个任务)
   - 完整系统测试
   - 回滚测试
   - 性能优化
   - 文档完成
   - 提交准备

#### 时间投入
- **计划**: 20-28 小时 (2 周)
- **基于 Phase 1 经验**: 可能 2-3 小时

---

## 📈 执行时间预测

### 计划 vs 实际（基于 Phase 1 经验）

| 阶段 | 任务数 | 计划时间 | 预估实际 | 效率 |
|------|--------|----------|----------|------|
| 2.1 Infrastructure | 27 | 14-20h | 2-3h | **90% 快** |
| 2.2 Data Layer | 45 | 20-30h | 3-5h | **85% 快** |
| 2.3 Calculation | 56 | 30-40h | 4-6h | **88% 快** |
| 2.4 Visualization | 33 | 20-28h | 2-3h | **90% 快** |
| **总计** | **161** | **84-118h** | **11-17h** | **87% 快** |

### 建议执行时间表

如果保持 Phase 1 的高效执行速度：
- **2-3 周** 完成所有 Phase 2 工作（而不是 8 周）
- **每周 5-6 小时** 的工作量
- 可以同时处理多个任务组

---

## 🎯 关键成果指标 (KPIs)

### Phase 2 完成标志

✅ **代码重复降低**
- HKEX 实现：7 个 → 1 个 (86% 减少)
- Agent 代码：BaseAgent + 13 RealAgent → 1 统一实现 (93% 减少)
- 回测引擎：4 个 → 1 个统一接口 (75% 减少)
- 总体重复率：30% → <5%

✅ **架构清晰度**
- 三层清晰分离
- 接口定义完整
- 职责边界明确
- 依赖关系单向

✅ **测试覆盖**
- 覆盖率 ≥85%
- 所有层都有专用测试
- 集成测试完整
- 性能基准建立

✅ **文档完整**
- 架构文档更新
- API 文档生成
- 开发指南更新
- 迁移指南完成

---

## 🚀 立即行动步骤

### Week 1: 准备和基础设施

**Day 1-2: 准备**
```bash
# 创建 feature 分支
git checkout -b feature/phase2-core-refactoring

# 更新提案状态
openspec apply refactor-core-architecture
```

**Day 3-5: 任务 1.1.1 - 目录结构**
```bash
# 创建所有必需的目录
mkdir -p src/{data_pipeline/{sources,cleaners,processors},core,database,visualization}
touch src/{data_pipeline/sources,data_pipeline/cleaners,data_pipeline/processors,core,database,visualization}/__init__.py
```

**Day 6-7: 任务 1.1.2-1.1.3 - 基础接口**
- 定义 6 个核心接口
- 完成类型提示和文档
- 编写单元测试

---

## ⚠️ 关键风险和缓解

| 风险 | 概率 | 影响 | 缓解 |
|------|------|------|------|
| Agent 迁移导致功能丢失 | 中 | 高 | 完整的 wrapper 支持，逐步迁移 |
| 数据源切换导致数据不一致 | 中 | 高 | 并行运行，数据验证，A/B 测试 |
| 性能回退 | 低 | 高 | 基准测试，分层测试，优化 |
| 测试覆盖不足 | 中 | 中 | 严格的覆盖率要求，集成测试 |
| 团队适应困难 | 低 | 中 | 文档完善，培训计划，逐步迁移 |

---

## 📝 提交策略

每个任务组提交一次：
1. **2.1 完成** → Commit: "feat: Phase 2.1 Infrastructure setup"
2. **2.2 完成** → Commit: "feat: Phase 2.2 Data layer implementation"
3. **2.3 完成** → Commit: "feat: Phase 2.3 Calculation layer implementation"
4. **2.4 完成** → Commit: "feat: Phase 2.4 Visualization and integration"

最后合并到 main 分支：
```bash
git checkout main
git merge feature/phase2-core-refactoring
```

---

**开始时间**: 2025-10-25
**完成时间**: 待更新
**状态**: 准备启动 ✅
